---
title: "Intake Differences by Species, Treatment, and Site (RHMA vs LARA)"
author: "Sarai Hutchinson"
date: "2025-09-01"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
params:
  out_dir:  "intake_outputs"
---


# 0) Setup & Plan

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 9, fig.height = 6)

suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(janitor)
  library(broom)
  library(emmeans)
  library(car)     # Type II/III Anova; Levene
  library(FSA)     # Dunn's test
  library(dplyr)
library(stringr)
library(tidyr)
  library(purrr)
  library(rstatix)
})

set.seed(20250901)

# Output dir
if (!dir.exists(params$out_dir)) dir.create(params$out_dir, recursive = TRUE, showWarnings = FALSE)

# Colorblind-friendly palette
okabe_ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")

# Define shapes for each Treatment_Name
shape_vals <- c(
  "Soil"                = 0,  # open square
  "Crushed glass"       = 17, # filled triangle
  "25% SG"              = 18, # filled diamond
  "75% SG"              = 8,  # asterisk
  "100% Sargassum (SG)" = 15  # filled square
)

# Define colors using okabe_ito palette
color_vals <- c(
  "Soil"                = okabe_ito[1], # green  (#009E73)
  "Crushed glass"       = okabe_ito[6], # blue   (#0072B2)
  "25% SG"              = okabe_ito[3], # orange (#E69F00)
  "75% SG"              = okabe_ito[2], # vermillion (#D55E00)
  "100% Sargassum (SG)" = okabe_ito[7]  # purple (#CC79A7)
)



# Robust MDY parser (handles 10/25/24 or 10/25/2024 and with optional times)
parse_mdy_relaxed <- function(x) suppressWarnings(parse_date_time(x, orders = c("mdy", "mdy HM", "mdy HMS")))
```

**Guiding questions**  
**Q1.** Intake differences between species (RHMA vs LARA)?  
**Q2.** Do initial substrates/treatments differ at intake?  
**Q3.** Are there site differences, and do they modify species/treatment effects?  

---

# 1. RHMA Intake

## 1.1 Read & Clean (hard-coded path)
```{r rhma-clean}
rhma_raw <- readr::read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/RHMA_IntakeData.csv", show_col_types = FALSE) %>% clean_names()

rhma1 <- rhma_raw %>%
  mutate(
    intake_date = parse_mdy_relaxed(intake_date),
    collection_date_raw = as.character(collection_date),

    # 1) first date-like token (left-to-right)
    .first = str_extract(collection_date_raw,
                         "\\b\\d{1,2}/\\d{1,2}(?:/\\d{2,4})?\\b"),

    # 2) append year if missing (use 2024, or use year(intake_date) — see variant below)
    collection_date_chr = case_when(
      is.na(.first) ~ NA_character_,
      str_detect(.first, "^\\d{1,2}/\\d{1,2}$") ~ paste0(.first, "/2024"),
      TRUE ~ .first
    ),

    # 3) parse to Date (keeps NA if nothing matched)
    collection_date = suppressWarnings(mdy(collection_date_chr))
  ) %>%
  select(-.first)

# How many still NA after parsing?
rhma1 %>% summarise(total=n(), parsed=sum(!is.na(collection_date)), na=sum(is.na(collection_date)))

# See examples that still fail to match the mm/dd pattern (if any)
rhma1 %>% filter(is.na(collection_date)) %>% distinct(collection_date_raw) %>% slice_head(n = 25)

num_cols_rhma <- c("diameter","epi_length","hypo_length","total_height","mass")

rhma2 <- rhma1 %>%
  mutate(across(all_of(num_cols_rhma), ~ suppressWarnings(as.numeric(str_replace_all(.x, ",", ""))))) %>%
  filter(!is.na(intake_date)) %>%
  arrange(prop_id, intake_date) %>%
  group_by(prop_id) %>% slice(1) %>% ungroup()

glimpse(rhma2)
```

```{r}
list(rhma_raw$collection_date)
```

## 1.2 QC flags
```{r rhma-qc}
rhma_qc_outliers <- rhma2 %>%
  pivot_longer(all_of(num_cols_rhma), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  mutate(
    iqr = IQR(value, na.rm = TRUE),
    Q1  = quantile(value, 0.25, na.rm = TRUE),
    Q3  = quantile(value, 0.75, na.rm = TRUE),
    lower = Q1 - 3*iqr,
    upper = Q3 + 3*iqr,
    is_extreme = value < lower | value > upper
  ) %>%
  ungroup() %>%
  filter(is_extreme & !is.na(value)) %>%
  arrange(trait, desc(value))

head(rhma_qc_outliers, 20)
# readr::write_csv(rhma_qc_outliers, file.path(params$out_dir, "rhma_qc_flagged_values.csv"))
```

## 1.3 Summaries (by Site × Treatment)
```{r rhma-summaries}
rhma_cont_summary <- rhma2 %>%
  pivot_longer(all_of(num_cols_rhma), names_to = "trait", values_to = "value") %>%
  group_by(site, treatment, trait) %>%
  summarise(n = sum(!is.na(value)), mean = mean(value, na.rm = TRUE), sd = sd(value, na.rm = TRUE), se = sd/sqrt(n), .groups = "drop") %>%
  mutate(mean_sd = sprintf("%.2f ± %.2f", mean, sd))

knitr::kable(rhma_cont_summary %>% arrange(trait, site, treatment), caption = "R. mangle continuous traits: mean ± sd by Site × Treatment")
# readr::write_csv(rhma_cont_summary, file.path(params$out_dir, "rhma_continuous_summary_by_site_treatment.csv"))
```

## 1.4 Assumptions (per-trait residual normality & Levene)
```{r rhma-assumptions}
check_norm_homo <- function(data, traits, group_vars = c("site","treatment")){
  purrr::map_dfr(traits, function(tr){
    df <- data %>% select(all_of(c(group_vars, tr))) %>% drop_na()
    if (nrow(df) < 8) return(tibble(trait = tr, shapiro_resid_p = NA_real_, levene_p = NA_real_))
    f <- lm(reformulate(paste(group_vars, collapse = "*"), response = tr), data = df)
    shp <- tryCatch(shapiro.test(residuals(f))$p.value, error = function(e) NA_real_)
    lev <- tryCatch(car::leveneTest(df[[tr]] ~ interaction(df[[group_vars[1]]], df[[group_vars[2]]]))$`Pr(>F)`[1], error = function(e) NA_real_)
    tibble(trait = tr, shapiro_resid_p = shp, levene_p = lev)
  })
}

rhma_assump <- check_norm_homo(rhma2, num_cols_rhma) %>%
  mutate(normality = if_else(shapiro_resid_p < 0.05, "Not normal", "OK"), homogeneity = if_else(levene_p < 0.05, "Unequal var", "OK"))

knitr::kable(rhma_assump, digits = 4, caption = "R. mangle: assumption checks")
# readr::write_csv(rhma_assump, file.path(params$out_dir, "rhma_assumption_checks.csv"))
```


---

### 1.5 Hypothesis tests (auto-switch to Kruskal–Wallis + Dunn when assumptions fail)
```{r rhma-tests}
cont_traits_rhma <- c("diameter","epi_length","hypo_length","total_height","mass")

# If any trait violates normality or homogeneity, use nonparametric tests for ALL RHMA traits
needs_np <- any(rhma_assump$shapiro_resid_p < 0.05 | rhma_assump$levene_p < 0.05, na.rm = TRUE)

if (needs_np) {
  message("Assumptions violated for R. mangle; running nonparametric tests for all R. mangle traits.")

  # Kruskal–Wallis across treatments within each site
  rhma_kw <- purrr::map_dfr(cont_traits_rhma, function(tr){
    df <- rhma2 %>% select(site, treatment, value = all_of(tr)) %>% drop_na()
    purrr::map_dfr(unique(df$site), function(si){
      sub <- df %>% filter(site == si)
      if (n_distinct(sub$treatment) > 1) {
        kw <- kruskal.test(value ~ treatment, data = sub)
        tibble(trait = tr, site = si, statistic = unname(kw$statistic), p_value = kw$p.value)
      } else tibble(trait = tr, site = si, statistic = NA_real_, p_value = NA_real_)
    })
  })

  # Dunn pairwise with Bonferroni adjustment
  dunn_rhma <- purrr::map_dfr(cont_traits_rhma, function(tr){
    df <- rhma2 %>% select(site, treatment, value = all_of(tr)) %>% drop_na()
    purrr::map_dfr(unique(df$site), function(si){
      sub <- df %>% filter(site == si)
      if (n_distinct(sub$treatment) > 1) {
        out <- suppressWarnings(FSA::dunnTest(value ~ treatment, data = sub, method = "bonferroni")$res)
        out$trait <- tr; out$site <- si
        as_tibble(out)
      } else tibble()
    })
  })

  # Optional saves
  # readr::write_csv(rhma_kw,   file.path(params$out_dir, "rhma_kw_alltraits_sitewise.csv"))
  # readr::write_csv(dunn_rhma, file.path(params$out_dir, "dunn_rhma_alltraits_sitewise.csv"))

  # Report tables
  knitr::kable(rhma_kw %>% arrange(trait, site),
               caption = "R. mangle Kruskal–Wallis across treatments within site (all traits)")

  if (nrow(dunn_rhma)) {
    dunn_rhma_sig <- dunn_rhma %>% rename(p_adj = P.adj) %>% filter(!is.na(p_adj) & p_adj < 0.05)
    if (nrow(dunn_rhma_sig) == 0) {
      knitr::kable(head(dunn_rhma, 10), caption = "R. mangle Dunn pairwise (head; none significant after correction)")
    } else {
      knitr::kable(dunn_rhma_sig %>% arrange(trait, site, p_adj),
                   caption = "R. mangle Dunn pairwise: significant contrasts (Bonferroni-adjusted p < 0.05)")
    }
  }

} else {
  # Parametric path (kept for completeness if future data pass assumptions)
  rhma_anova <- purrr::map_dfr(cont_traits_rhma, function(tr){
    df <- rhma2 %>% select(site, treatment, !!sym(tr)) %>% drop_na()
    if (nrow(df) < 8 || n_distinct(df$treatment) < 2) return(tibble(trait = tr, term = NA, p.value = NA))
    fit <- lm(reformulate(c("site","treatment","site:treatment"), response = tr), data = df)
    broom::tidy(anova(fit)) %>% mutate(trait = tr)
  })
  knitr::kable(rhma_anova %>% filter(!is.na(p.value)) %>% select(trait, term, p.value) %>% arrange(trait, term),
               caption = "R. mangle ANOVA (site × treatment)")
}

# New: significant contrasts only (Bonferroni p_adj < 0.05)
dunn_sig <- dunn_rhma %>% rename(p_adj = P.adj) %>% filter(!is.na(p_adj) & p_adj < 0.05)
if (nrow(dunn_sig) > 0) {
knitr::kable(dunn_sig %>% arrange(trait, site, p_adj),
caption = "R. mangle Dunn pairwise: significant contrasts (Bonferroni-adjusted p < 0.05)")}
```

```{r rhma-dunn-sig}
# Filter to Bonferroni-adjusted p < 0.05
dunn_rhma_sig <- dunn_rhma %>%
rename(p_adj = P.adj, comparison = Comparison, z = Z, p_unadj = P.unadj) %>%
filter(!is.na(p_adj) & p_adj < 0.05) %>%
select(trait, site, comparison, z, p_unadj, p_adj) %>%
arrange(trait, site, p_adj)


# Print one table per trait for readability
if (nrow(dunn_rhma_sig) == 0) {
knitr::kable(head(dunn_rhma, 10), caption = "R. mangle Dunn pairwise: none significant after Bonferroni; showing head of full results")
} else {
traits_order <- unique(dunn_rhma_sig$trait)
for (tr in traits_order) {
sub <- dunn_rhma_sig %>% filter(trait == tr)
if (nrow(sub) > 0) {
cat("


**Trait:** ", tr, "


", sep = "")
print(knitr::kable(sub, caption = paste0("R. mangle Dunn significant contrasts (Bonferroni p < 0.05): ", tr)))
}
}
}


# Optional: save to CSV for supplement
# readr::write_csv(dunn_rhma_sig, file.path(params$out_dir, "dunn_rhma_significant_only.csv"))
```


## 1.6 Plots
```{r rhma-plots}
p_rhma <- rhma2 %>%
  pivot_longer(c(total_height, epi_length, diameter, mass), names_to = "trait", values_to = "value") %>%
  ggplot(aes(x = treatment, y = value)) +
  geom_boxplot(outlier.alpha = 0.5) +
  geom_jitter(width = 0.15, alpha = 0.4, size = 1) +
  facet_grid(trait ~ site, scales = "free_y") +
  labs(x = "Treatment", y = "Value", title = "R. mangle: Intake trait distributions by Treatment (faceted by Site)") +
  theme_bw(base_size = 12)

p_rhma
# ggsave(file.path(params$out_dir, "rhma_boxplots.png"), p_rhma, dpi = 300, width = 10, height = 7)
```

---

# 2. LARA Intake

## 2.1 Read & Clean (hard-coded path)
```{r lara-clean}
lara_raw <- readr::read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/LARA_IntakeData.csv", show_col_types = FALSE) %>% clean_names()

lara1 <- lara_raw %>%
  mutate(
    prop_id = coalesce(.data$prop_id),
    site      = str_squish(as.character(site)),
    species   = "LARA",
    treatment = str_squish(as.character(treatment)),
    seed_color = str_squish(as.character(seed_color))
  ) %>%
  mutate(
    intake_date = parse_mdy_relaxed(intake_date),
    collection_date = {cd <- stringr::str_extract(collection_date, "\\b\\d{1,2}/\\d{1,2}/\\d{2,4}\\b"); parse_mdy_relaxed(cd)}
  )

num_cols_lara <- c("width","prop_length","rad_length","total_length","mass")

lara2 <- lara1 %>%
  mutate(across(all_of(num_cols_lara), ~ suppressWarnings(as.numeric(str_replace_all(.x, ",", ""))))) %>%
  filter(!is.na(intake_date)) %>%
  arrange(prop_id, intake_date) %>%
  group_by(prop_id) %>% slice(1) %>% ungroup()

glimpse(lara2)
```

## 2.2 QC flags
```{r lara-qc}
lara_qc_outliers <- lara2 %>%
  pivot_longer(all_of(num_cols_lara), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  mutate(
    iqr = IQR(value, na.rm = TRUE),
    Q1  = quantile(value, 0.25, na.rm = TRUE),
    Q3  = quantile(value, 0.75, na.rm = TRUE),
    lower = Q1 - 3*iqr,
    upper = Q3 + 3*iqr,
    is_extreme = value < lower | value > upper
  ) %>% ungroup() %>% filter(is_extreme & !is.na(value)) %>% arrange(trait, desc(value))

head(lara_qc_outliers, 20)
# readr::write_csv(lara_qc_outliers, file.path(params$out_dir, "lara_qc_flagged_values.csv"))
```

## 2.3 Summaries (by Site × Treatment)
```{r lara-summaries}
lara_cont_summary <- lara2 %>%
  pivot_longer(all_of(num_cols_lara), names_to = "trait", values_to = "value") %>%
  group_by(site, treatment, trait) %>%
  summarise(n = sum(!is.na(value)), mean = mean(value, na.rm = TRUE), sd = sd(value, na.rm = TRUE), se = sd/sqrt(n), .groups = "drop") %>%
  mutate(mean_sd = sprintf("%.2f ± %.2f", mean, sd))

knitr::kable(lara_cont_summary %>% arrange(trait, site, treatment), caption = "LARA continuous traits by Site × Treatment")
# readr::write_csv(lara_cont_summary, file.path(params$out_dir, "lara_continuous_summary_by_site_treatment.csv"))
```

## 2.4 Assumptions
```{r lara-assumptions}
lara_assump <- check_norm_homo(lara2, num_cols_lara)
lara_assump <- lara_assump %>% mutate(normality = if_else(shapiro_resid_p < 0.05, "Not normal", "OK"), homogeneity = if_else(levene_p < 0.05, "Unequal var", "OK"))
knitr::kable(lara_assump, digits = 4, caption = "LARA: assumption checks")
```


## 2.5 Non-parametric tests (Kruskal–Wallis + Dunn)
```{r lara-nonparam}
cont_traits_lara <- c("width","prop_length","rad_length","total_length","mass")
cont_traits_lara <- num_cols_lara


# Kruskal–Wallis per trait × site
kw_lara <- map_dfr(cont_traits_lara, function(tr){
df <- lara2 %>% select(site, treatment, !!sym(tr)) %>% drop_na()
map_dfr(unique(df$site), function(si){
sub <- df %>% filter(site == si)
if(n_distinct(sub$treatment) > 1){
kw <- kruskal.test(reformulate("treatment", tr), data = sub)
tibble(trait = tr, site = si, statistic = unname(kw$statistic), p_value = kw$p.value)
} else tibble()
})
})

dunn_lara <- map_dfr(cont_traits_lara, function(tr) { df <- lara_intake %>% select(site, treatment, !!sym(tr)) %>% drop_na() map_dfr(unique(df$site), function(s) { sub <- df %>% filter(site == s) if(n_distinct(sub$treatment) > 1) { dt <- dunnTest(reformulate("treatment", tr), data = sub, method = "bonferroni") out <- dt$res out$trait <- tr out$site <- s out } else { tibble() } }) }) 

head(dunn_lara)


# 1) resolve columns & traits actually present
site_nm  <- intersect(c("site","Site"), names(lara2))[1]
treat_nm <- intersect(c("treatment","treatment_name","Treatment_Name"), names(lara2))[1]
stopifnot(!is.na(site_nm), !is.na(treat_nm))

traits <- intersect(cont_traits_lara, names(lara2))
stopifnot(length(traits) > 0)

# 2) long format
long <- lara2 %>%
  select(site = all_of(site_nm),
         treatment = all_of(treat_nm),
         all_of(traits)) %>%
  pivot_longer(cols = all_of(traits), names_to = "trait", values_to = "value") %>%
  mutate(value = suppressWarnings(as.numeric(value))) %>%
  drop_na(site, treatment, value)

# 3) keep only (site, trait) groups with ≥3 treatments and ≥2 obs per treatment
ok_groups <- long %>%
  count(site, trait, treatment, name = "n") %>%
  group_by(site, trait) %>%
  summarise(k = n(), min_n = min(n), .groups = "drop") %>%
  filter(k >= 3, min_n >= 2)

# 4) Dunn tests by site × trait (Bonferroni)
dunn_lara <- long %>%
  semi_join(ok_groups, by = c("site","trait")) %>%
  group_by(site, trait) %>%
  dunn_test(value ~ treatment, p.adjust.method = "bonferroni") %>%
  ungroup()

# Significant only (optional)
dunn_lara_sig <- dunn_lara %>%
  filter(p.adj < 0.05) %>%
  arrange(trait, site, p.adj)

# knitr::kable(head(kw_lara, 10), caption = "LARA Kruskal–Wallis (first 10 rows)")
knitr::kable(head(dunn_lara, 10), caption = "LARA Dunn pairwise tests (first 10 rows)")
```


### 2.5a Significant Dunn contrasts (clean report tables)
```{r lara-dunn-sig}
# Filter to Bonferroni-adjusted p < 0.05
lara_dunn_sig <- dunn_lara %>%
rename(p_adj = P.adj, comparison = Comparison, z = Z, p_unadj = P.unadj) %>%
filter(!is.na(p_adj) & p_adj < 0.05) %>%
select(trait, site, comparison, z, p_unadj, p_adj) %>%
arrange(trait, site, p_adj)


if (nrow(dunn_lara_sig) == 0) {
knitr::kable(head(dunn_lara, 10), caption = "LARA Dunn pairwise: none significant after Bonferroni; showing head of full results")
} else {
traits_order <- unique(dunn_lara_sig$trait)
for (tr in traits_order) {
sub <- dunn_lara_sig %>% filter(trait == tr)
if (nrow(sub) > 0) {
cat("


**Trait:** ", tr, "


", sep = "")
print(knitr::kable(sub, caption = paste0("LARA Dunn significant contrasts (Bonferroni p < 0.05): ", tr)))
}
}
}


# Optional: save to CSV for supplement
# readr::write_csv(lara_dunn_sig, file.path(params$out_dir, "lara_dunn_significant_only.csv"))
```


## 2.6 Plots
```{r lara-plots}
p_lara <- lara2 %>%
pivot_longer(c(total_length,width, mass), names_to = "trait", values_to = "value") %>%
ggplot(aes(x = treatment, y = value)) +
geom_boxplot(outlier.alpha = 0.5) +
geom_jitter(width = 0.15, alpha = 0.4, size = 1) +
facet_grid(trait ~ site, scales = "free_y") +
labs(x = "Treatment", y = "Value", title = "L. racemosa: Intake traits by Treatment (Dunn)") +
theme_bw(base_size = 12)


p_lara
```

---

# 5. Session info
```{r session}
writeLines(capture.output(sessionInfo()), file.path(params$out_dir, "sessionInfo.txt"))
sessionInfo()
```

