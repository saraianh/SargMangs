---
title: "Mangrove Seedling Survivorship Analysis"
author: "Sarai Hutchinson"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)

# Load required libraries
library(tidyverse)
library(ggplot2)
library(survival)
library(survminer)
library(knitr)
library(kableExtra)
library(emmeans)
library(multcomp)
library(car)
library(broom)
library(lme4)
library(lmerTest)

# Define Okabe-Ito colorblind-friendly palette
okabe_ito <- c("#009E73", "#D55E00", "#E69F00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7", "#999999")

# Define shapes for each Treatment_Name
shape_vals <- c(
  "Soil"                = 0,  # open square
  "Crushed glass"       = 17, # filled triangle
  "25% SG"              = 18, # filled diamond
  "75% SG"              = 8,  # asterisk
  "100% Sargassum (SG)" = 15  # filled square
)

# Define colors using okabe_ito palette
color_vals <- c(
  "Soil"                = okabe_ito[1], # green  (#009E73)
  "Crushed glass"       = okabe_ito[6], # blue   (#0072B2)
  "25% SG"              = okabe_ito[3], # orange (#E69F00)
  "75% SG"              = okabe_ito[2], # vermillion (#D55E00)
  "100% Sargassum (SG)" = okabe_ito[7]  # purple (#CC79A7)
)
```

# Introduction

This analysis examines the effect of different substrate types on the
survivorship of red (*Rhizophora mangle*, RHMA) and white (*Laguncularia
racemosa*, LARA) mangrove seedlings.

## Treatments

1.  **Soil**: Traditional potting soil (control)
2.  **Crushed glass**: 100% crushed glass substrate
3.  **25% SG**: 3:1 ratio of crushed glass to *Sargassum*
4.  **75% SG**: 1:3 ratio of crushed glass to *Sargassum*
5.  **100% Sargassum (SG)**: Pure *Sargassum* substrate

## Hypotheses

### Red Mangroves (*Rhizophora mangle*)

-   **H₀₁**: There is no difference in the survivorship of red mangrove
    seedlings regardless of treatment.
-   **H₁₁**: Red mangroves grown in potting soil will have the greatest
    survivorship, followed by crushed glass, 25% SG, 75% SG, and 100%
    *Sargassum*.

### White Mangroves (*Laguncularia racemosa*)

-   **H₀₂**: There is no difference in the survivorship of white
    mangrove propagules regardless of substrate type.
-   **H₁₂**: White mangroves grown in potting soil will exhibit the
    greatest survivorship, followed by crushed glass, 25% SG, 75% SG,
    and 100% *Sargassum*.

# Data Import and Preparation

```{r data-import}
# Read data
ALLDATA <- read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/Hutchinson_MonitoringAndIntake_Sites.csv")

# Clean treatment labels
ALLDATA <- ALLDATA %>%
  mutate(
    Treatment_Name = case_when(
      Treatment == "A" ~ "Soil",
      Treatment == "B" ~ "Crushed glass",
      Treatment == "C" ~ "100% Sargassum (SG)",
      Treatment == "D" ~ "25% SG",
      Treatment == "E" ~ "75% SG",
      TRUE ~ as.character(Treatment)
    ),
    Treatment_Name = factor(
      Treatment_Name,
      levels = c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)")
    )
  )

# Derive Sargassum indicators
ALLDATA <- ALLDATA %>%
  mutate(
    Sarg_present = if_else(
      Treatment_Name %in% c("75% SG", "25% SG", "100% Sargassum (SG)"),
      1L, 0L
    ),
    Sarg_group = factor(if_else(Sarg_present == 1L, "With Sargassum", "No Sargassum"),
                        levels = c("No Sargassum","With Sargassum")),
    SG_pct = case_when(
      Treatment_Name == "Soil" ~ 0,
      Treatment_Name == "Crushed glass" ~ 0,
      Treatment_Name == "25% SG" ~ 25,
      Treatment_Name == "75% SG" ~ 75,
      Treatment_Name == "100% Sargassum (SG)"~ 100,
      TRUE ~ NA_real_
    )
  )

# Create binary survival variable
ALLDATA_SurvBin <- ALLDATA %>%
  mutate(
    Surv_Bin = ifelse(Survivorship %in% c("A", "DY"), 1, 0),
    Time_Period = factor(Time_Period, levels = c("0", "1", "2", "3", "4", "5", "6")),
    Species = factor(Species),
    Site        = factor(Site)
  )
```

## Quality Control

```{r qc-resurrections}
# Check for resurrection cases (0→1 transitions)
qc_resurrections <- ALLDATA_SurvBin %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%
  arrange(Species, Prop_ID, TP_num) %>%
  group_by(Species, Prop_ID) %>%
  mutate(change = Surv_Bin - lag(Surv_Bin)) %>%
  filter(change == 1 & lag(Surv_Bin) == 0) %>%
  ungroup()

flagged_ids <- qc_resurrections %>% distinct(Species, Prop_ID)

cat("Number of plants with resurrection issues:", nrow(flagged_ids), "\n")

# Remove flagged plants
ALLDATA_clean <- ALLDATA_SurvBin %>%
  anti_join(flagged_ids, by = c("Species","Prop_ID"))

cat("Original observations:", nrow(ALLDATA_SurvBin))
cat("\nClean observations:", nrow(ALLDATA_clean))
cat("\nObservations removed:", nrow(ALLDATA_SurvBin) - nrow(ALLDATA_clean))
```

# Exploratory Data Analysis

## Sample Size Overview

```{r sample-size}
# Initial sample sizes
initial_counts <- ALLDATA_clean %>%
  filter(Time_Period == "0") %>%
  group_by(Treatment_Name, Species) %>%
  summarise(n_initial = n()) %>%
  pivot_wider(names_from = Species, values_from = n_initial, values_fill = 0)

initial_counts %>%
  kable(caption = "Initial Sample Sizes by Treatment and Species") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Site distribution
site_dist <- ALLDATA_clean %>%
  filter(Time_Period == "0") %>%
  group_by(Site, Treatment_Name) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Treatment_Name, values_from = n, values_fill = 0)

site_dist %>%
  kable(caption = "Distribution across Sites") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Survival Over Time

```{r survival-time-series}
# Calculate survival rates by time period
survival_by_time <- ALLDATA_clean %>%
  group_by(Time_Period, Treatment_Name, Species) %>%
  summarise(
    n_total = n(),
    n_alive = sum(Surv_Bin),
    survival_rate = mean(Surv_Bin) * 100
    # se = sqrt(survival_rate * (100 - survival_rate) / n_total)
  ) %>%
  ungroup()

# --- Survival by REPLICATE (percentage within each Replicate/TP/Treatment/Species) ---
survival_by_time_reps <- ALLDATA_clean %>%
  group_by(Species, Treatment_Name, Replicate, Time_Period) %>%
  summarise(
    n_total   = sum(!is.na(Surv_Bin)),
    n_alive   = sum(Surv_Bin == 1, na.rm = TRUE),
    surv_pct  = 100 * n_alive / n_total,
    .groups = "drop"
  )

# --- Mean across replicates (unweighted mean of replicate %s) + SE + 95% CI ---
survival_by_time_mean <- survival_by_time_reps %>%
  group_by(Species, Treatment_Name, Time_Period) %>%
  summarise(
    n_reps    = dplyr::n(),
    mean_surv = mean(surv_pct, na.rm = TRUE),
    sd_surv   = sd(surv_pct, na.rm = TRUE),
    se_surv   = sd_surv / sqrt(n_reps),
    ci95      = qt(0.975, pmax(n_reps - 1, 1)) * se_surv,
    .groups = "drop"
  ) %>%
  arrange(Species, Treatment_Name, Time_Period)

# Plot survival curves
p_survival_curves <- ggplot(survival_by_time, 
             aes(x = as.numeric(as.character(Time_Period)), 
                 y = survival_rate, 
                 color = Treatment_Name,
                 shape = Treatment_Name,
                 group = Treatment_Name)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  # geom_ribbon(aes(ymin = survival_rate - se, 
  #                 ymax = survival_rate + se,
  #                 fill = Treatment_Name), 
  #             alpha = 0.15, 
  #             linetype = 0) +
  facet_wrap(~ Species, labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)", 
                                                         "RHMA" = "R. mangle (RHMA)"))) +
  scale_color_manual(values = color_vals) +
  scale_fill_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Survival Rates Over 6 Months by Treatment and Species",
       x = "Months",
       y = "Survival Rate (%)",
       color = "Treatment",
       shape = "Treatment",
       fill = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))

print(p_survival_curves)

# --- Plot: mean across replicates (thick line) + SE ribbon ---
p_survival_curves2 <- ggplot() +
  # SE ribbon
  geom_ribbon(
    data = survival_by_time_mean,
    aes(x = Time_Period,
        ymin = mean_surv - se_surv,
        ymax = mean_surv + se_surv,
        fill = Treatment_Name,
        group = Treatment_Name),
    alpha = 0.12, linetype = 0
  ) +
  # Mean line + points
  geom_line(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, group = Treatment_Name),
    linewidth = 1.2
  ) +
  geom_point(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, shape = Treatment_Name),
    size = 3
  ) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)",
                                             "RHMA" = "R. mangle (RHMA)"))) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = c(0.02, 0.05))) +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals,  name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  labs(title = "Survival (%) Over 6 Months — Mean of Replicates (±SE)",
       x = "Months", y = "Survival Rate (%)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))
print(p_survival_curves2)

# --- Show each replicate as thin lines behind the mean ---
p_survival_curves3 <- ggplot() +
  # replicate trajectories
  geom_line(
    data = survival_by_time_reps,
    aes(x = Time_Period, y = surv_pct,
        group = interaction(Treatment_Name, Replicate),
        color = Treatment_Name),
    alpha = 0.35, linewidth = 0.6
  ) +
  # mean across replicates
  geom_line(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, group = Treatment_Name),
    linewidth = 1.2
  ) +
  geom_point(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, shape = Treatment_Name),
    size = 2.6
  ) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)",
                                             "RHMA" = "R. mangle (RHMA)"))) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = c(0.02, 0.05))) +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  labs(title = "Survival (%) Over 6 Months — Replicates (thin) + Mean",
       x = "Months", y = "Survival Rate (%)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))
print(p_survival_curves3)
```

## Final Survival Rates

```{r final-survival}
# Get final survival rates
latest_survival <- survival_by_time %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%   # TP3 -> 3
  filter(Time_Period == max(Time_Period, na.rm = TRUE)) %>%
  dplyr::select(Treatment_Name, Species, n_total, n_alive, survival_rate) %>%
  arrange(Species, desc(survival_rate))

latest_survival %>%
  kable(caption = "Final Survival Rates by Treatment and Species",
        col.names = c("Treatment", "Species", "Total", "Alive", "Survival Rate (%)"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) 

write.csv(latest_survival,
          file = "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\latest_survival.csv", row.names = FALSE)

# Bar plot of final survival
p_final_survival <- latest_survival %>%
  ggplot(aes(x = Treatment_Name, y = survival_rate, fill = Treatment_Name)) +
  geom_col(alpha = 0.8) +
  # geom_errorbar(aes(ymin = survival_rate - se, ymax = survival_rate),
  #               width = 0.25) +
  facet_wrap(~ Species, labeller = labeller(Species = c("LARA" = "L. racemosa", 
                                                        "RHMA" = "R. mangle"))) +
  scale_fill_manual(values = color_vals) +
  labs(title = "Final Survival Rates by Treatment",
       x = "Treatment",
       y = "Survival Rate (%)",
       fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_final_survival)
```

```{r alive-plants}
#Step 1: make a dataframe that has all alive plants with survivorship percentages
alive_plants <- ALLDATA_clean %>%
  group_by(Species, Treatment_Name, Replicate, Time_Period) %>%
  summarise(
    alive_n = sum(Surv_Bin == 1, na.rm = TRUE),
    total_n = n(),
    alive_pct = (alive_n / total_n) * 100,
    .groups = "drop"
  )%>%
  arrange(Species, Treatment_Name, Time_Period, Replicate)

# Ensure Time_Period is character only in this pipeline (don’t globally change earlier)
tp_dat <- ALLDATA_clean %>%
  mutate(Time_Period_chr = as.character(Time_Period))

# Alive at TP0 and TP6 only
alive_tp0_6 <- tp_dat %>%
  filter(Time_Period_chr %in% c("0","6"), Surv_Bin == 1)

# IDs alive at BOTH endpoints (species-safe)
survivors_both <- alive_tp0_6 %>%
  distinct(Species, Prop_ID, Time_Period_chr) %>%
  count(Species, Prop_ID, name = "n_tp") %>%
  filter(n_tp == 2) %>%
  dplyr::select(Species, Prop_ID)

# Quick counts per species
survivor_counts <- survivors_both %>%
  count(Species, name = "n_survivors")

print(survivor_counts)
# Expect similar to: RHMA ~ 266, LARA ~ 76

# --- Step 3: Separate lists for RHMA and LARA ---------------------------
RHMA_survivors <- survivors_both %>% filter(Species == "RHMA") %>% distinct(Prop_ID)
LARA_survivors <- survivors_both %>% filter(Species == "LARA") %>% distinct(Prop_ID)

# Peek
head(RHMA_survivors); nrow(RHMA_survivors)
head(LARA_survivors); nrow(LARA_survivors)

# Full histories for just those survivors (still no-flags)
survivor_full_history <- ALLDATA_clean %>%
  inner_join(survivors_both, by = c("Species","Prop_ID"))

# Export the full dataset of ALLDATA (all time periods) to CSV
write.csv(survivor_full_history, "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\survivors_tp0-tp6.csv", row.names = FALSE)

```

## *Sargassum* Effect

```{r sargassum-effect}
# Compare treatments by Sargassum presence
treatment_comparison <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period)) %>%
  group_by(Treatment_Name, Sarg_group, Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    se = sqrt(survival_rate * (100 - survival_rate) / n)
  )

p_sarg_effect <- ggplot(treatment_comparison, 
             aes(x = Treatment_Name, y = survival_rate, fill = Treatment_Name)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = survival_rate - se, ymax = survival_rate + se),
                width = 0.25) +
  facet_grid(Species ~ Sarg_group, scales = "free_x", space = "free_x",
             labeller = labeller(Species = c("RHMA" = "R. mangle", 
                                            "LARA" = "L. racemosa"))) +
  scale_fill_manual(values = color_vals) +
  labs(title = "Survival by Sargassum Presence",
       x = "Treatment",
       y = "Survival Rate (%)",
       fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_sarg_effect)

# Summary statistics
sarg_summary <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period)) %>%
  group_by(Sarg_group, Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    se = sqrt(survival_rate * (100 - survival_rate) / n)
  )

sarg_summary %>%
  kable(caption = "Survival by Sargassum Presence",
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Statistical Analysis

## Chi-square Test for Independence

```{r chi-square}
final_data <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period)) %>%
  mutate(Site = droplevels(Site))  # safety

# Red mangroves (RHMA)
rhma_data <- final_data %>% filter(Species == "RHMA")
if(nrow(rhma_data) > 0) {
  rhma_contingency <- table(rhma_data$Treatment_Name, rhma_data$Surv_Bin)
  cat("Red Mangroves - Contingency Table:\n")
  print(rhma_contingency)
  
  rhma_chi <- chisq.test(rhma_contingency)
  cat("\nRed Mangroves - Chi-square Test:\n")
  print(rhma_chi)
}

# White mangroves (LARA)
lara_data <- final_data %>% filter(Species == "LARA")
if(nrow(lara_data) > 0) {
  lara_contingency <- table(lara_data$Treatment_Name, lara_data$Surv_Bin)
  cat("\n\nWhite Mangroves - Contingency Table:\n")
  print(lara_contingency)
  
  lara_chi <- chisq.test(lara_contingency)
  cat("\nWhite Mangroves - Chi-square Test:\n")
  print(lara_chi)
}
```

## Logistic Regression

```{r logistic-regression}
# Fit logistic regression model
logit_model <- glm(Surv_Bin ~ Treatment_Name * Species, 
                   data = final_data, 
                   family = binomial(link = "logit"))

cat("Logistic Regression Model Summary:\n")
summary(logit_model)

cat("\n\nAnalysis of Deviance:\n")
anova(logit_model, test = "Chisq")
```
```{r site-adjusted-logistic-regression}
# Site-adjusted logistic regression (fixed effect for Site)
logit_model_site <- glm(
  Surv_Bin ~ Species * Treatment_Name + Site,
  data   = final_data,
  family = binomial()
)

cat("Site-adjusted logistic regression:\n")
summary(logit_model_site)

# Type-III (Wald) tests for main effects & interaction
car::Anova(logit_model_site, type = 3, test.statistic = "Wald")

# EMMs: treatment means within species, marginalizing over Site
emm_site <- emmeans(logit_model_site, ~ Treatment_Name | Species, type = "response")
summary(emm_site)
pairs(emm_site, by = "Species", adjust = "tukey") %>% summary(exp = TRUE)  # odds ratios
```


## Post-hoc Comparisons

```{r posthoc}

# Estimated marginal means
emmeans_survival <- emmeans(logit_model, ~ Treatment_Name | Species, type = "response")
cat("Estimated Marginal Means (Survival Probability):\n")
print(summary(emmeans_survival))

# Pairwise within each species
pairs_by <- pairs(emmeans_survival, by = "Species", adjust = "tukey")

# Print both species nicely
summary(pairs_by)                    # log-odds (β) differences
summary(pairs_by, exp = TRUE)        # odds ratios (recommended)

#If you want data frames (easy to filter/report)
pairs_df      <- as.data.frame(summary(pairs_by))
pairs_df_or   <- as.data.frame(summary(pairs_by, exp = TRUE))  # with ORs

# Separate tables:
pairs_lara <- subset(pairs_df_or, Species == "LARA")
pairs_rhma <- subset(pairs_df_or, Species == "RHMA")

```

Re-fit the model using Firth logistif since there was complete
separation due to all the soil and crushed glass surviving for RHMA.
This led to differences in the other 3 not being as apparent though.

```{r}
library(logistf)
library(emmeans)

analyze_species_survival <- function(data, species_name) {
  dat_sp <- subset(data, Species == species_name)
  dat_sp <- droplevels(dat_sp)

  # Firth with Site as fixed effect
  firth_mod <- logistf(Surv_Bin ~ Treatment_Name + Site, data = dat_sp)

  cat("\n===== Results for", species_name, "(Firth + Site) =====\n")
  print(summary(firth_mod))

  # EMMs average over Site (marginal means on prob scale)
  emm <- emmeans(firth_mod, ~ Treatment_Name, type = "response")
  cat("\nEstimated Survival Probabilities (Site-adjusted):\n")
  print(summary(emm))

  pairs_res <- pairs(emm, adjust = "tukey")
  cat("\nPairwise Comparisons (ORs):\n")
  print(summary(pairs_res, exp = TRUE))

  invisible(list(model = firth_mod, emmeans = emm, pairs = pairs_res))
}

# Run on TP6 slice (final_data)
lara_results <- analyze_species_survival(final_data, "LARA")
rhma_results <- analyze_species_survival(final_data, "RHMA")

```
OLD RESULTS WITHOUT SITE
===== Results for LARA =====
logistf(formula = Surv_Bin ~ Treatment_Name, data = dat_sp)

Model fitted by Penalized ML
Coefficients:
                                        coef  se(coef) lower 0.95 upper 0.95    Chisq            p method
(Intercept)                        0.4125323 0.2659365 -0.1024181  0.9460255  2.45779 1.169432e-01      2
Treatment_NameCrushed glass       -1.2998355 0.3890944 -2.0808326 -0.5505331 11.77598 6.000007e-04      2
Treatment_Name25% SG              -1.3230923 0.3883987 -2.1028822 -0.5753239 12.26531 4.614570e-04      2
Treatment_Name75% SG              -2.5389308 0.4928661 -3.5818661 -1.6273063 34.66431 3.917483e-09      2
Treatment_Name100% Sargassum (SG) -4.0930435 0.8684443 -6.3170069 -2.6762992 54.84956 1.301181e-13      2

Method: 1-Wald, 2-Profile penalized log-likelihood, 3-None

Likelihood ratio test=65.72676 on 4 df, p=1.808553e-13, n=297
Wald test = 68.59075 on 4 df, p = 4.507505e-14logistf(formula = Surv_Bin ~ Treatment_Name, data = dat_sp)
Model fitted by Penalized ML
Confidence intervals and p-values by Profile Likelihood 

Coefficients:
                      (Intercept)       Treatment_NameCrushed glass              Treatment_Name25% SG 
                        0.4125323                        -1.2998355                        -1.3230923 
             Treatment_Name75% SG Treatment_Name100% Sargassum (SG) 
                       -2.5389308                        -4.0930435 

Likelihood ratio test=65.72676 on 4 df, p=1.808553e-13, n=297


Estimated Survival Probabilities:
 Treatment_Name        prob     SE  df lower.CL upper.CL
 Soil                0.6017 0.0637 292  0.47231    0.718
 Crushed glass       0.2917 0.0587 292  0.19057    0.419
 25% SG              0.2869 0.0579 292  0.18729    0.413
 75% SG              0.1066 0.0395 292  0.05006    0.213
 100% Sargassum (SG) 0.0246 0.0198 292  0.00493    0.114

Confidence level used: 0.95 
Intervals are back-transformed from the logit scale 

Pairwise Comparisons:
 contrast                            odds.ratio    SE  df null t.ratio p.value
 Soil / Crushed glass                      3.67  1.43 292    1   3.341  0.0083
 Soil / 25% SG                             3.76  1.46 292    1   3.407  0.0067
 Soil / 75% SG                            12.67  6.24 292    1   5.151  <.0001
 Soil / 100% Sargassum (SG)               59.92 52.00 292    1   4.713  <.0001
 Crushed glass / 25% SG                    1.02  0.41 292    1   0.058  1.0000
 Crushed glass / 75% SG                    3.45  1.74 292    1   2.464  0.1018
 Crushed glass / 100% Sargassum (SG)      16.33 14.30 292    1   3.195  0.0133
 25% SG / 75% SG                           3.37  1.69 292    1   2.420  0.1127
 25% SG / 100% Sargassum (SG)             15.96 13.90 292    1   3.170  0.0145
 75% SG / 100% Sargassum (SG)              4.73  4.38 292    1   1.680  0.4479

P value adjustment: tukey method for comparing a family of 5 estimates 
Tests are performed on the log odds ratio scale 

===== Results for RHMA =====
logistf(formula = Surv_Bin ~ Treatment_Name, data = dat_sp)

Model fitted by Penalized ML
Coefficients:
                                           coef se(coef) lower 0.95 upper 0.95      Chisq            p method
(Intercept)                        4.795791e+00 1.420045   2.862264   9.633379        Inf 0.000000e+00      2
Treatment_NameCrushed glass       -1.915700e-14 2.008247  -5.225110   5.225110  0.0000000 1.000000e+00      2
Treatment_Name25% SG              -1.115279e+00 1.643168  -6.106598   1.836020  0.5315816 4.659427e-01      2
Treatment_Name75% SG              -4.258648e+00 1.444627  -9.113646  -2.229864 31.9970213 1.544092e-08      2
Treatment_Name100% Sargassum (SG) -3.336165e+00 1.457288  -8.200039  -1.255346 13.5804481 2.285537e-04      2

Method: 1-Wald, 2-Profile penalized log-likelihood, 3-None

Likelihood ratio test=58.37152 on 4 df, p=6.376566e-12, n=300
Wald test = 66.60976 on 4 df, p = 1.177947e-13logistf(formula = Surv_Bin ~ Treatment_Name, data = dat_sp)
Model fitted by Penalized ML
Confidence intervals and p-values by Profile Likelihood 

Coefficients:
                      (Intercept)       Treatment_NameCrushed glass              Treatment_Name25% SG 
                     4.795791e+00                     -1.915700e-14                     -1.115279e+00 
             Treatment_Name75% SG Treatment_Name100% Sargassum (SG) 
                    -4.258648e+00                     -3.336165e+00 

Likelihood ratio test=58.37152 on 4 df, p=6.376566e-12, n=300


Estimated Survival Probabilities:
 Treatment_Name       prob     SE  df lower.CL upper.CL
 Soil                0.992 0.0115 295    0.881    0.999
 Crushed glass       0.992 0.0115 295    0.881    0.999
 25% SG              0.975 0.0198 295    0.886    0.995
 75% SG              0.631 0.0618 295    0.504    0.743
 100% Sargassum (SG) 0.811 0.0501 295    0.693    0.891

Confidence level used: 0.95 
Intervals are back-transformed from the logit scale 

Pairwise Comparisons:
 contrast                            odds.ratio      SE  df null t.ratio p.value
 Soil / Crushed glass                     1.000   2.010 295    1   0.000  1.0000
 Soil / 25% SG                            3.050   5.010 295    1   0.679  0.9609
 Soil / 75% SG                           70.714 102.000 295    1   2.948  0.0283
 Soil / 100% Sargassum (SG)              28.111  41.000 295    1   2.289  0.1512
 Crushed glass / 25% SG                   3.050   5.010 295    1   0.679  0.9609
 Crushed glass / 75% SG                  70.714 102.000 295    1   2.948  0.0283
 Crushed glass / 100% Sargassum (SG)     28.111  41.000 295    1   2.289  0.1512
 25% SG / 75% SG                         23.182  20.100 295    1   3.620  0.0032
 25% SG / 100% Sargassum (SG)             9.215   8.190 295    1   2.498  0.0939
 75% SG / 100% Sargassum (SG)             0.398   0.168 295    1  -2.189  0.1867

P value adjustment: tukey method for comparing a family of 5 estimates 
Tests are performed on the log odds ratio scale 




## Mixed Effects Model

This code has the impact of the complete separation caused by the RHMA
survivorship

```{r mixed-model, eval=FALSE, include=FALSE}
# Account for repeated measures and site effects
ALLDATA_model <- ALLDATA_clean %>%
  mutate(Time_num = as.numeric(as.character(Time_Period)))

# Fit mixed effects logistic regression
mixed_model <- glmer(Surv_Bin ~ Treatment_Name + 
                     (1 | Prop_ID) + (1 | Site),
                     data = ALLDATA_model,
                     family = binomial,
                     control = glmerControl(optimizer = "bobyqa"))


cat("Mixed Effects Model Summary:\n")
summary(mixed_model)

cat("\n\nFixed Effects Significance:\n")
anova(mixed_model)
```

Re-run but separate the species

```{r eval=FALSE, include=FALSE}
# --- White mangroves ---
lara_data <- subset(ALLDATA_model, Species == "LARA")

glmer_lara <- glmer(Surv_Bin ~ Treatment_Name + 
                      (1 | Prop_ID) + (1 | Site),
                    data = lara_data,
                    family = binomial,
                    control = glmerControl(optimizer = "bobyqa"))

summary(glmer_lara)

emm_lara <- emmeans(glmer_lara, ~ Treatment_Name, type = "response")
summary(emm_lara)
pairs(emm_lara, adjust = "tukey")


# --- Red mangroves ---
rhma_data <- subset(ALLDATA_model, Species == "RHMA")

glmer_rhma <- glmer(Surv_Bin ~ Treatment_Name + 
                      (1 | Prop_ID) + (1 | Site),
                    data = rhma_data,
                    family = binomial,
                    control = glmerControl(optimizer = "bobyqa"))

summary(glmer_rhma)

emm_rhma <- emmeans(glmer_rhma, ~ Treatment_Name, type = "response")
summary(emm_rhma)
pairs(emm_rhma, adjust = "tukey")
```
OLD RESULTS
Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
 Family: binomial  ( logit )
Formula: Surv_Bin ~ Treatment_Name + (1 | Prop_ID) + (1 | Site)
   Data: lara_data
Control: glmerControl(optimizer = "bobyqa")

      AIC       BIC    logLik -2*log(L)  df.resid 
   2300.8    2340.3   -1143.4    2286.8      2072 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.0531 -0.5512 -0.4326  0.3576  2.3216 

Random effects:
 Groups  Name        Variance Std.Dev.
 Prop_ID (Intercept) 2.7018   1.6437  
 Site    (Intercept) 0.1725   0.4153  
Number of obs: 2079, groups:  Prop_ID, 297; Site, 3

Fixed effects:
                                  Estimate Std. Error z value Pr(>|z|)    
(Intercept)                         1.6103     0.3751   4.294 1.76e-05 ***
Treatment_NameCrushed glass        -1.6347     0.3801  -4.301 1.70e-05 ***
Treatment_Name25% SG               -1.5443     0.3794  -4.070 4.70e-05 ***
Treatment_Name75% SG               -2.6810     0.3835  -6.991 2.73e-12 ***
Treatment_Name100% Sargassum (SG)  -2.6507     0.3820  -6.938 3.97e-12 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Correlation of Fixed Effects:
            (Intr) Tr_NCg T_N25S T_N75S
Trtmnt_NmCg -0.572                     
Trtm_N25%SG -0.574  0.558              
Trtm_N75%SG -0.582  0.561  0.564       
T_N100%S(SG -0.586  0.565  0.568  0.577
 Treatment_Name       prob     SE  df asymp.LCL asymp.UCL
 Soil                0.833 0.0521 Inf     0.706     0.913
 Crushed glass       0.494 0.0873 Inf     0.330     0.659
 25% SG              0.517 0.0869 Inf     0.351     0.679
 75% SG              0.255 0.0660 Inf     0.148     0.404
 100% Sargassum (SG) 0.261 0.0664 Inf     0.152     0.410

Confidence level used: 0.95 
Intervals are back-transformed from the logit scale 
 contrast                            odds.ratio    SE  df null z.ratio p.value
 Soil / Crushed glass                     5.128 1.950 Inf    1   4.301  0.0002
 Soil / 25% SG                            4.685 1.780 Inf    1   4.070  0.0005
 Soil / 75% SG                           14.600 5.600 Inf    1   6.991  <.0001
 Soil / 100% Sargassum (SG)              14.164 5.410 Inf    1   6.938  <.0001
 Crushed glass / 25% SG                   0.914 0.326 Inf    1  -0.253  0.9991
 Crushed glass / 75% SG                   2.847 1.020 Inf    1   2.926  0.0284
 Crushed glass / 100% Sargassum (SG)      2.762 0.981 Inf    1   2.860  0.0344
 25% SG / 75% SG                          3.116 1.110 Inf    1   3.191  0.0124
 25% SG / 100% Sargassum (SG)             3.024 1.070 Inf    1   3.127  0.0152
 75% SG / 100% Sargassum (SG)             0.970 0.342 Inf    1  -0.086  1.0000

P value adjustment: tukey method for comparing a family of 5 estimates 
Tests are performed on the log odds ratio scale 
Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
 Family: binomial  ( logit )
Formula: Surv_Bin ~ Treatment_Name + (1 | Prop_ID) + (1 | Site)
   Data: rhma_data
Control: glmerControl(optimizer = "bobyqa")

      AIC       BIC    logLik -2*log(L)  df.resid 
    491.2     530.7    -238.6     477.2      2093 

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.72435  0.00000  0.00695  0.02292  2.11614 

Random effects:
 Groups  Name        Variance Std.Dev.
 Prop_ID (Intercept) 32.15    5.67    
 Site    (Intercept)  0.00    0.00    
Number of obs: 2100, groups:  Prop_ID, 300; Site, 3

Fixed effects:
                                  Estimate Std. Error z value Pr(>|z|)
(Intercept)                         27.679     38.377   0.721    0.471
Treatment_NameCrushed glass         -6.264     45.798  -0.137    0.891
Treatment_Name25% SG               -17.752     38.443  -0.462    0.644
Treatment_Name75% SG               -21.472     38.385  -0.559    0.576
Treatment_Name100% Sargassum (SG)  -20.246     38.383  -0.527    0.598

Correlation of Fixed Effects:
            (Intr) Tr_NCg T_N25S T_N75S
Trtmnt_NmCg -0.090                     
Trtm_N25%SG -0.999  0.090              
Trtm_N75%SG -1.000  0.090  0.999       
T_N100%S(SG -1.000  0.090  0.999  1.000
optimizer (bobyqa) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')

 Treatment_Name           prob       SE  df asymp.LCL asymp.UCL
 Soil                1.0000000 0.00e+00 Inf 0.0000000 1.0000000
 Crushed glass       1.0000000 2.85e-08 Inf 0.0000000 1.0000000
 25% SG              0.9999512 9.05e-05 Inf 0.9981539 0.9999987
 75% SG              0.9979898 2.35e-03 Inf 0.9803995 0.9997971
 100% Sargassum (SG) 0.9994091 6.38e-04 Inf 0.9951173 0.9999287

Confidence level used: 0.95 
Intervals are back-transformed from the logit scale 
 contrast                            odds.ratio       SE  df null z.ratio p.value
 Soil / Crushed glass                  5.25e+02 2.41e+04 Inf    1   0.137  0.9999
 Soil / 25% SG                         5.12e+07 1.97e+09 Inf    1   0.462  0.9907
 Soil / 75% SG                         2.11e+09 8.11e+10 Inf    1   0.559  0.9808
 Soil / 100% Sargassum (SG)            6.21e+08 2.38e+10 Inf    1   0.527  0.9846
 Crushed glass / 25% SG                9.75e+04 5.57e+06 Inf    1   0.201  0.9996
 Crushed glass / 75% SG                4.02e+06 2.30e+08 Inf    1   0.267  0.9989
 Crushed glass / 100% Sargassum (SG)   1.18e+06 6.74e+07 Inf    1   0.245  0.9992
 25% SG / 75% SG                       4.10e+01 7.50e+01 Inf    1   2.047  0.2435
 25% SG / 100% Sargassum (SG)          1.20e+01 2.20e+01 Inf    1   1.372  0.6457
 75% SG / 100% Sargassum (SG)          0.00e+00 0.00e+00 Inf    1  -1.274  0.7076

P value adjustment: tukey method for comparing a family of 5 estimates 
Tests are performed on the log odds ratio scale 



# Repeated-measures mixed models: keep Site, choose fixed vs random (both shown)
```{r}
ALLDATA_model <- ALLDATA_clean %>%
  mutate(Time_num = as.numeric(as.character(Time_Period)),
         Site     = droplevels(Site))

# --- FIXED Site effect (marginal means will average over Site) ---
glmer_fixedSite_LARA <- glmer(
  Surv_Bin ~ Treatment_Name + Site + (1 | Prop_ID),
  data = subset(ALLDATA_model, Species == "LARA"),
  family = binomial(),
  control = glmerControl(optimizer = "bobyqa")
)

glmer_fixedSite_RHMA <- glmer(
  Surv_Bin ~ Treatment_Name + Site + (1 | Prop_ID),
  data = subset(ALLDATA_model, Species == "RHMA"),
  family = binomial(),
  control = glmerControl(optimizer = "bobyqa")
)

summary(glmer_fixedSite_LARA); summary(glmer_fixedSite_RHMA)
emm_lara <- emmeans(glmer_fixedSite_LARA, ~ Treatment_Name, type = "response")
emm_rhma <- emmeans(glmer_fixedSite_RHMA, ~ Treatment_Name, type = "response")
pairs(emm_lara, adjust = "tukey"); pairs(emm_rhma, adjust = "tukey")

# --- RANDOM Site effect (as you had) ---
glmer_randomSite_LARA <- glmer(
  Surv_Bin ~ Treatment_Name + (1 | Prop_ID) + (1 | Site),
  data = subset(ALLDATA_model, Species == "LARA"),
  family = binomial(),
  control = glmerControl(optimizer = "bobyqa")
)

glmer_randomSite_RHMA <- glmer(
  Surv_Bin ~ Treatment_Name + (1 | Prop_ID) + (1 | Site),
  data = subset(ALLDATA_model, Species == "RHMA"),
  family = binomial(),
  control = glmerControl(optimizer = "bobyqa")
)

# Quick model selection by AIC (lower is better)
AIC(glmer_fixedSite_LARA, glmer_randomSite_LARA)
AIC(glmer_fixedSite_RHMA, glmer_randomSite_RHMA)
```



## *Sargassum* Gradient Analysis

```{r sargassum-gradient}
# Analyze Sargassum as continuous predictor
gradient_model <- glm(Surv_Bin ~ SG_pct * Species + Site, 
                      data = final_data,
                      family = binomial)

cat("Sargassum Gradient Model:\n")
summary(gradient_model)

# Visualize gradient effect
gradient_pred <- expand.grid(
  SG_pct = seq(0, 100, by = 5),
  Species = unique(final_data$Species)
)

gradient_pred$pred_survival <- predict(gradient_model, 
                                       newdata = gradient_pred, 
                                       type = "response")

obs_data <- final_data %>%
  group_by(SG_pct, Species, Treatment_Name) %>%
  summarise(obs_survival = mean(Surv_Bin) * 100) %>%
  ungroup()

p_gradient <- ggplot(gradient_pred, aes(x = SG_pct, y = pred_survival * 100)) +
  geom_line(aes(color = Species), size = 1.5, alpha = 0.8) +
  geom_point(data = obs_data,
             aes(y = obs_survival, color = Species, shape = Treatment_Name), 
             size = 4, alpha = 0.9) +
  scale_color_manual(values = c("RHMA" = "#D73502", "LARA" = "#8B7355"),
                    labels = c("RHMA" = "R. mangle", "LARA" = "L. racemosa")) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Survival Rate vs Sargassum Percentage",
       x = "Sargassum Content (%)",
       y = "Survival Rate (%)",
       color = "Species",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "right")

print(p_gradient)
```

## Kaplan-Meier Survival Analysis

I feel like this is important to show how quickly they died across
treatments. However, I need some more clarification on this.

```{r kaplan-meier}
# Prepare data for survival analysis
surv_data <- ALLDATA_clean %>%
  group_by(Species, Prop_ID, Treatment_Name) %>%
  summarise(
    last_alive = max(as.numeric(as.character(Time_Period[Surv_Bin == 1])), na.rm = TRUE),
    final_status = ifelse(any(Surv_Bin == 0), 1, 0),  # 1 = died, 0 = censored
    survival_time = ifelse(final_status == 1, 
                          min(as.numeric(as.character(Time_Period[Surv_Bin == 0])), na.rm = TRUE),
                          max(as.numeric(as.character(Time_Period))))
  ) %>%
  ungroup()

# # Create survival object
# surv_obj <- Surv(time = surv_data$survival_time, event = surv_data$final_status)
# 
# # Fit survival curves
# fit <- survfit(surv_obj ~ Treatment_Name + Species, data = surv_data)
# 
# # Plot Kaplan-Meier curves
# ggsurvplot(fit, 
#            data = surv_data,
#            pval = TRUE,
#            conf.int = TRUE,
#            risk.table = TRUE,
#            risk.table.height = 0.3,
#            palette = "jco",
#            legend.title = "Treatment:Species",
#            title = "Kaplan-Meier Survival Curves")
# 
# fit_lara <- survfit(Surv(survival_time, final_status) ~ Treatment_Name,
#                     data = subset(surv_data, Species == "LARA"))
# fit_rhma <- survfit(Surv(survival_time, final_status) ~ Treatment_Name,
#                     data = subset(surv_data, Species == "RHMA"))

# 1) Shorten labels (add a simple factor just for plotting)
surv_data2 <- surv_data %>%
  mutate(
    Treatment = dplyr::recode(
      Treatment_Name,
      "Soil"                  = "Soil",
      "Crushed glass"         = "CG",
      "25% SG"                = "25% SG",
      "75% SG"                = "75% SG",
      "100% Sargassum (SG)"   = "100% SG"
    ),
    Species          = factor(as.character(Species)),
    Treatment = factor(Treatment,
                              levels = c("Soil", "CG", "25% SG", "75% SG", "100% SG"))
  )

# 2) Fit KM models per species
lara_dat <- droplevels(subset(surv_data2, Species == "LARA"))
rhma_dat <- droplevels(subset(surv_data2, Species == "RHMA"))

fit_lara <- survfit(Surv(survival_time, final_status) ~ Treatment, data = lara_dat)
fit_rhma <- survfit(Surv(survival_time, final_status) ~ Treatment, data = rhma_dat)

# 3) Plot settings (consistent look)
p_lara <- ggsurvplot(
  fit_lara, data = lara_dat,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, risk.table.height = 0.22,
  risk.table.fontsize = 3,
  risk.table.y.text.col = TRUE, risk.table.y.text = FALSE,
  legend.title = "Treatment",
  title = "L. racemosa — Kaplan–Meier",
  palette = "jco"
)

p_rhma <- ggsurvplot(
  fit_rhma, data = rhma_dat,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, risk.table.height = 0.22,
  risk.table.fontsize = 3,
  risk.table.y.text.col = TRUE, risk.table.y.text = FALSE,
  legend.title = "Treatment",
  title = "R. mangle — Kaplan–Meier",
  palette = "jco"
)

# 4) Arrange side-by-side with a shared legend at the bottom
kap_meier_plots<-arrange_ggsurvplots(
  list(p_lara, p_rhma),
  ncol = 2, nrow = 1,
  common.legend = TRUE,
  legend = "bottom"
)
print(kap_meier_plots)

# Save it as PNG
ggsave("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\kap-meier-survival-plots.png", plot = kap_meier_plots, width = 18, height = 8, dpi = 500)

```

Kaplan–Meier: optional Site-adjusted hazard models

If you want to adjust the time-to-event comparison for Site (rather than stratify curves by Site, which gets busy), use a Cox model with Site either as a covariate or as a strata (strata gives a site-stratified log-rank):
```{r optional}
# Using your lara_dat / rhma_dat from the KM section
cox_lara <- coxph(Surv(survival_time, final_status) ~ Treatment + strata(Site), data = lara_dat)
cox_rhma <- coxph(Surv(survival_time, final_status) ~ Treatment + strata(Site), data = rhma_dat)

summary(cox_lara); summary(cox_rhma)

# Plot stratified-adjusted survival curves (predictions by Treatment, averaged over strata)
ggsurvplot(survfit(cox_lara), data = lara_dat, legend.title = "Treatment",
           title = "L. racemosa — Cox (strata: Site)", pval = TRUE, conf.int = TRUE)
ggsurvplot(survfit(cox_rhma), data = rhma_dat, legend.title = "Treatment",
           title = "R. mangle — Cox (strata: Site)", pval = TRUE, conf.int = TRUE)
```


# Results Summary

## Treatment Rankings

```{r rankings}
# Rank treatments by survival
survival_ranks <- latest_survival %>%
  group_by(Species) %>%
  arrange(desc(survival_rate)) %>%
  mutate(rank = row_number()) %>%
  dplyr::select(Species, Treatment_Name, survival_rate, rank)

survival_ranks %>%
  kable(caption = "Treatment Rankings by Survival Rate",
        col.names = c("Species", "Treatment", "Survival Rate (%)", "Rank"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(survival_ranks$Treatment_Name == "Soil"), bold = TRUE)
```

## Hypothesis Testing Results

```{r hypothesis-results}
alpha <- 0.05
expected_order <- c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)")

cat(strrep("=", 60), "\n")
cat("HYPOTHESIS TESTING RESULTS\n")
cat(strrep("=", 60), "\n")

# H1: Red mangroves
if(exists("rhma_chi")) {
  cat("Red Mangroves (H₀₁):\n")
  result <- ifelse(rhma_chi$p.value < alpha, 
                  "REJECT null hypothesis - Significant treatment effect",
                  "FAIL TO REJECT null hypothesis - No significant treatment effect")
  cat("  Decision:", result, "\n")
  cat("  p-value:", round(rhma_chi$p.value, 4), "\n")
  
  # Check ranking
  rhma_actual <- survival_ranks %>%
    filter(Species == "RHMA") %>%
    arrange(rank) %>%
    pull(Treatment_Name)
  
  cat("\n  Expected ranking:", paste(expected_order, collapse = " > "), "\n")
  cat("  Actual ranking:  ", paste(rhma_actual, collapse = " > "), "\n")
  cat("  Match:", ifelse(all(rhma_actual == expected_order), "YES ✓", "NO ✗"), "\n\n")
}

# H2: White mangroves
if(exists("lara_chi")) {
  cat("White Mangroves (H₀₂):\n")
  result <- ifelse(lara_chi$p.value < alpha,
                  "REJECT null hypothesis - Significant treatment effect",
                  "FAIL TO REJECT null hypothesis - No significant treatment effect")
  cat("  Decision:", result, "\n")
  cat("  p-value:", round(lara_chi$p.value, 4), "\n")
  
  # Check ranking
  lara_actual <- survival_ranks %>%
    filter(Species == "LARA") %>%
    arrange(rank) %>%
    pull(Treatment_Name)
  
  cat("\n  Expected ranking:", paste(expected_order, collapse = " > "), "\n")
  cat("  Actual ranking:  ", paste(lara_actual, collapse = " > "), "\n")
  cat("  Match:", ifelse(all(lara_actual == expected_order), "YES ✓", "NO ✗"), "\n")
}
```

## Key Findings

```{r key-findings}
# Overall survival statistics
cat("OVERALL SURVIVAL STATISTICS:\n\n")

overall_stats <- final_data %>%
  group_by(Treatment_Name) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    alive = sum(Surv_Bin),
    dead = n - alive
  ) %>%
  arrange(desc(survival_rate))

overall_stats %>%
  kable(caption = "Overall Survival by Treatment (Both Species Combined)",
        col.names = c("Treatment", "N", "Survival %", "Alive", "Dead"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Sargassum effect
cat("\n\nSARGASSUM EFFECT:\n")
sarg_effect <- final_data %>%
  group_by(Sarg_group) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100
  )

effect_size <- diff(sarg_effect$survival_rate)
cat("Difference (No Sargassum - With Sargassum):", round(effect_size, 2), "%\n")

# Species comparison
cat("\n\nSPECIES COMPARISON:\n")
species_stats <- final_data %>%
  group_by(Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100
  )

species_stats %>%
  kable(caption = "Overall Survival by Species",
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Conclusions

Based on the comprehensive survivorship analysis:

1.  **Treatment Effects**: Statistical tests reveal whether substrate
    type significantly affects survivorship in both red and white
    mangroves.

2.  **Hypothesis Support**: The analysis evaluates whether the
    hypothesized ranking (Soil \> Crushed glass \> 25% SG \> 75% SG \>
    100% *Sargassum*) is supported by the data.

3.  ***Sargassum*** **Impact**: Clear evidence shows the negative effect
    of *Sargassum* presence on seedling survival, with a dose-dependent
    response.

4.  **Species-Specific Responses**: The analysis reveals whether red and
    white mangroves respond differently to the treatments.

5.  **Practical Implications**: Results suggest that traditional potting
    soil remains the optimal substrate for mangrove restoration, while
    *Sargassum*-containing substrates should be avoided or minimized.

Based on the statistical analyses:

## Survivorship Findings

### Red Mangroves (*Rhizophora mangle*)

**Hypothesis Testing:** - **Null Hypothesis 1**: There is no difference
in survivorship of red mangrove seedlings regardless of treatment. -
**Results**: [To be filled based on your actual results] - Overall
treatment effect: [Significant/Not significant] (p = [value]) -
Treatment ranking observed: [List actual order from your data] -
Expected ranking: Soil \> Crushed glass \> 75% SG \> 25% SG \> 100%
*Sargassum* (SG) -Actual RHMA ranking: Soil \> Crushed glass \> 75% SG
\> 100% *Sargassum* (SG) \> 25% SG -Actual LARA ranking: Soil \> Crushed
glass \> 75% SG \> 25% SG \> 100% *Sargassum* (SG) - Survival curve
differences: [Significant/Not significant] (Log-rank p = [value])

**Key Survivorship Findings for Red Mangroves:** - [Interpret whether
soil performed best as hypothesized] - [Describe *Sargassum* gradient
effects on survival] - [Note any unexpected survival patterns] -
[Comment on timing of mortality if relevant]

### White Mangroves (*Laguncularia racemosa*)

**Hypothesis Testing:** - **Null Hypothesis 2**: There is no difference
in survivorship of white mangrove propagules regardless of substrate
type. - **Results**: [To be filled based on your actual results] -
Overall treatment effect: [Significant/Not significant] (p = [value]) -
Treatment ranking observed: [List actual order from your data] -
Expected ranking: Soil \> Crushed glass \> 75% SG \> 25% SG \> 100%
*Sargassum* (SG) - Survival curve differences: [Significant/Not
significant] (Log-rank p = [value])

**Key Survivorship Findings for White Mangroves:** - [Interpret whether
soil performed best as hypothesized] - [Describe *Sargassum* gradient
effects on survival] - [Note any species-specific survival responses] -
[Comment on timing of mortality if relevant]

## Sargassum Effects on Survivorship

**Gradient Analysis:** - ***Sargassum*** **percentage effect on Red
mangrove survival**: [Linear relationship present/absent] -
***Sargassum*** **percentage effect on White mangrove survival**:
[Linear relationship present/absent] - ***Sargassum*** **presence vs
absence on survival**: [Beneficial/Detrimental/No effect] - **Optimal
*Sargassum* concentration**: [25%/75%/100% or none]

## Species Survivorship Comparisons

-   **Overall survival differences**: [Compare red vs white performance
    across treatments]
-   **Treatment-specific survival differences**: [Species responses
    within each treatment]
-   **Interaction effects**: [Whether species respond differently to
    treatments]
-   **Mortality timing**: [Early vs late mortality patterns by species]

## Survival Curve Analysis

-   **Time-to-event patterns**: [Describe when mortality occurred in
    different treatments]
-   **Treatment separation**: [When survival curves diverged]
-   **Risk periods**: [Identify high-mortality time periods]

## Hypothesis Conclusions

### Null Hypothesis 1 (Red mangroves): **[ACCEPT/REJECT]**

**Rationale**: [Based on statistical significance and effect sizes]

### Null Hypothesis 2 (White mangroves): **[ACCEPT/REJECT]**

**Rationale**: [Based on statistical significance and effect sizes]

## Ecological Implications

**For Mangrove Restoration:** - [Recommend best substrate based on
results] - [Discuss cost-benefit of different treatments] - [Consider
species-specific recommendations]

**Sargassum Utilization:** - [Evaluate potential for *Sargassum* use in
restoration] - [Discuss optimal Sargassum concentrations if
beneficial] - [Consider environmental benefits of *Sargassum* recycling]

**Study Limitations:** - [Note any data quality issues, sample size
limitations] - [Discuss temporal scale and environmental factors] -
[Suggest future research directions]

## Recommendations

1.  **For Red Mangrove Restoration**: [Specific substrate
    recommendation]
2.  **For White Mangrove Restoration**: [Specific substrate
    recommendation]\
3.  ***Sargassum*** **Management**: [Recommendations for *Sargassum*
    use]
4.  **Future Research**: [Suggest long-term studies, additional factors
    to investigate]

------------------------------------------------------------------------

*Analysis completed with
`r nrow(distinct(ALLDATA_clean, Species, Prop_ID))` unique plants across
`r length(unique(ALLDATA_clean$Treatment_Name))` treatments over
`r length(unique(ALLDATA_clean$Time_Period))` time periods. Quality
control removed `r nrow(flagged_ids)` plants with data inconsistencies.*

# Session Information

```{r session-info} sessionInfo()}
```
