---
title: "Mangrove Seedling Survivorship Analysis"
author: "Sarai Hutchinson"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)

# Load required libraries
library(tidyverse)
library(ggplot2)
library(survival)
library(survminer)
library(knitr)
library(kableExtra)
library(emmeans)
library(multcomp)
library(car)
library(broom)
library(lme4)
library(lmerTest)

# Define Okabe-Ito colorblind-friendly palette
okabe_ito <- c("#009E73", "#D55E00", "#E69F00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7", "#999999")

# Define shapes for each Treatment_Name
shape_vals <- c(
  "Soil"                = 0,  # open square
  "Crushed glass"       = 17, # filled triangle
  "25% SG"              = 18, # filled diamond
  "75% SG"              = 8,  # asterisk
  "100% Sargassum (SG)" = 15  # filled square
)

# Define colors using okabe_ito palette
color_vals <- c(
  "Soil"                = okabe_ito[1], # green  (#009E73)
  "Crushed glass"       = okabe_ito[6], # blue   (#0072B2)
  "25% SG"              = okabe_ito[3], # orange (#E69F00)
  "75% SG"              = okabe_ito[2], # vermillion (#D55E00)
  "100% Sargassum (SG)" = okabe_ito[7]  # purple (#CC79A7)
)
```

# Introduction

This analysis examines the effect of different substrate types on the
survivorship of red (*Rhizophora mangle*, RHMA) and white (*Laguncularia
racemosa*, LARA) mangrove seedlings.

## Treatments

1.  **Soil**: Traditional potting soil (control)
2.  **Crushed glass**: 100% crushed glass substrate
3.  **25% SG**: 3:1 ratio of crushed glass to *Sargassum*
4.  **75% SG**: 1:3 ratio of crushed glass to *Sargassum*
5.  **100% Sargassum (SG)**: Pure *Sargassum* substrate

## Hypotheses

### Red Mangroves (*Rhizophora mangle*)

-   **H₀₁**: There is no difference in the survivorship of red mangrove
    seedlings regardless of treatment.
-   **H₁₁**: Red mangroves grown in potting soil will have the greatest
    survivorship, followed by crushed glass, 25% SG, 75% SG, and 100%
    *Sargassum*.

### White Mangroves (*Laguncularia racemosa*)

-   **H₀₂**: There is no difference in the survivorship of white
    mangrove propagules regardless of substrate type.
-   **H₁₂**: White mangroves grown in potting soil will exhibit the
    greatest survivorship, followed by crushed glass, 25% SG, 75% SG,
    and 100% *Sargassum*.

# Data Import and Preparation

```{r data-import}
# Read data
ALLDATA <- read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/Hutchinson_MonitoringAndIntake_Sites.csv")

# Clean treatment labels
ALLDATA <- ALLDATA %>%
  mutate(
    Treatment_Name = case_when(
      Treatment == "A" ~ "Soil",
      Treatment == "B" ~ "Crushed glass",
      Treatment == "C" ~ "100% Sargassum (SG)",
      Treatment == "D" ~ "25% SG",
      Treatment == "E" ~ "75% SG",
      TRUE ~ as.character(Treatment)
    ),
    Treatment_Name = factor(
      Treatment_Name,
      levels = c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)")
    )
  )

# Derive Sargassum indicators
ALLDATA <- ALLDATA %>%
  mutate(
    Sarg_present = if_else(
      Treatment_Name %in% c("75% SG", "25% SG", "100% Sargassum (SG)"),
      1L, 0L
    ),
    Sarg_group = factor(if_else(Sarg_present == 1L, "With Sargassum", "No Sargassum"),
                        levels = c("No Sargassum","With Sargassum")),
    SG_pct = case_when(
      Treatment_Name == "Soil" ~ 0,
      Treatment_Name == "Crushed glass" ~ 0,
      Treatment_Name == "25% SG" ~ 25,
      Treatment_Name == "75% SG" ~ 75,
      Treatment_Name == "100% Sargassum (SG)"~ 100,
      TRUE ~ NA_real_
    )
  )

# Create binary survival variable
ALLDATA_SurvBin <- ALLDATA %>%
  mutate(
    Surv_Bin = ifelse(Survivorship %in% c("A", "DY"), 1, 0),
    Time_Period = factor(Time_Period, levels = c("0", "1", "2", "3", "4", "5", "6")),
    Species = factor(Species)
  )
```

## Quality Control

```{r qc-resurrections}
# Check for resurrection cases (0→1 transitions)
qc_resurrections <- ALLDATA_SurvBin %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%
  arrange(Species, Prop_ID, TP_num) %>%
  group_by(Species, Prop_ID) %>%
  mutate(change = Surv_Bin - lag(Surv_Bin)) %>%
  filter(change == 1 & lag(Surv_Bin) == 0) %>%
  ungroup()

flagged_ids <- qc_resurrections %>% distinct(Species, Prop_ID)

cat("Number of plants with resurrection issues:", nrow(flagged_ids), "\n")

# Remove flagged plants
ALLDATA_clean <- ALLDATA_SurvBin %>%
  anti_join(flagged_ids, by = c("Species","Prop_ID"))

cat("Original observations:", nrow(ALLDATA_SurvBin))
cat("\nClean observations:", nrow(ALLDATA_clean))
cat("\nObservations removed:", nrow(ALLDATA_SurvBin) - nrow(ALLDATA_clean))
```

# Exploratory Data Analysis

## Sample Size Overview

```{r sample-size}
# Initial sample sizes
initial_counts <- ALLDATA_clean %>%
  filter(Time_Period == "0") %>%
  group_by(Treatment_Name, Species) %>%
  summarise(n_initial = n()) %>%
  pivot_wider(names_from = Species, values_from = n_initial, values_fill = 0)

initial_counts %>%
  kable(caption = "Initial Sample Sizes by Treatment and Species") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Site distribution
site_dist <- ALLDATA_clean %>%
  filter(Time_Period == "0") %>%
  group_by(Site, Treatment_Name) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Treatment_Name, values_from = n, values_fill = 0)

site_dist %>%
  kable(caption = "Distribution across Sites") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Survival Over Time

```{r survival-time-series}
# Calculate survival rates by time period
survival_by_time <- ALLDATA_clean %>%
  group_by(Time_Period, Treatment_Name, Species) %>%
  summarise(
    n_total = n(),
    n_alive = sum(Surv_Bin),
    survival_rate = mean(Surv_Bin) * 100
    # se = sqrt(survival_rate * (100 - survival_rate) / n_total)
  ) %>%
  ungroup()

# --- Survival by REPLICATE (percentage within each Replicate/TP/Treatment/Species) ---
survival_by_time_reps <- ALLDATA_clean %>%
  group_by(Species, Treatment_Name, Replicate, Time_Period) %>%
  summarise(
    n_total   = sum(!is.na(Surv_Bin)),
    n_alive   = sum(Surv_Bin == 1, na.rm = TRUE),
    surv_pct  = 100 * n_alive / n_total,
    .groups = "drop"
  )

# --- Mean across replicates (unweighted mean of replicate %s) + SE + 95% CI ---
survival_by_time_mean <- survival_by_time_reps %>%
  group_by(Species, Treatment_Name, Time_Period) %>%
  summarise(
    n_reps    = dplyr::n(),
    mean_surv = mean(surv_pct, na.rm = TRUE),
    sd_surv   = sd(surv_pct, na.rm = TRUE),
    se_surv   = sd_surv / sqrt(n_reps),
    ci95      = qt(0.975, pmax(n_reps - 1, 1)) * se_surv,
    .groups = "drop"
  ) %>%
  arrange(Species, Treatment_Name, Time_Period)

# Plot survival curves
p_survival_curves <- ggplot(survival_by_time, 
             aes(x = as.numeric(as.character(Time_Period)), 
                 y = survival_rate, 
                 color = Treatment_Name,
                 shape = Treatment_Name,
                 group = Treatment_Name)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  # geom_ribbon(aes(ymin = survival_rate - se, 
  #                 ymax = survival_rate + se,
  #                 fill = Treatment_Name), 
  #             alpha = 0.15, 
  #             linetype = 0) +
  facet_wrap(~ Species, labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)", 
                                                         "RHMA" = "R. mangle (RHMA)"))) +
  scale_color_manual(values = color_vals) +
  scale_fill_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Survival Rates Over 6 Months by Treatment and Species",
       x = "Months",
       y = "Survival Rate (%)",
       color = "Treatment",
       shape = "Treatment",
       fill = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))

print(p_survival_curves)

# --- Plot: mean across replicates (thick line) + SE ribbon ---
p_survival_curves2 <- ggplot() +
  # SE ribbon
  geom_ribbon(
    data = survival_by_time_mean,
    aes(x = Time_Period,
        ymin = mean_surv - se_surv,
        ymax = mean_surv + se_surv,
        fill = Treatment_Name,
        group = Treatment_Name),
    alpha = 0.12, linetype = 0
  ) +
  # Mean line + points
  geom_line(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, group = Treatment_Name),
    linewidth = 1.2
  ) +
  geom_point(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, shape = Treatment_Name),
    size = 3
  ) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)",
                                             "RHMA" = "R. mangle (RHMA)"))) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = c(0.02, 0.05))) +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals,  name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  labs(title = "Survival (%) Over 6 Months — Mean of Replicates (±SE)",
       x = "Months", y = "Survival Rate (%)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))
print(p_survival_curves2)

# --- Show each replicate as thin lines behind the mean ---
p_survival_curves3 <- ggplot() +
  # replicate trajectories
  geom_line(
    data = survival_by_time_reps,
    aes(x = Time_Period, y = surv_pct,
        group = interaction(Treatment_Name, Replicate),
        color = Treatment_Name),
    alpha = 0.35, linewidth = 0.6
  ) +
  # mean across replicates
  geom_line(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, group = Treatment_Name),
    linewidth = 1.2
  ) +
  geom_point(
    data = survival_by_time_mean,
    aes(x = Time_Period, y = mean_surv,
        color = Treatment_Name, shape = Treatment_Name),
    size = 2.6
  ) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "L. racemosa (LARA)",
                                             "RHMA" = "R. mangle (RHMA)"))) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = c(0.02, 0.05))) +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  labs(title = "Survival (%) Over 6 Months — Replicates (thin) + Mean",
       x = "Months", y = "Survival Rate (%)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))
print(p_survival_curves3)
```

## Final Survival Rates

```{r final-survival}
# Get final survival rates
latest_survival <- survival_by_time %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%   # TP3 -> 3
  filter(Time_Period == max(Time_Period, na.rm = TRUE)) %>%
  dplyr::select(Treatment_Name, Species, n_total, n_alive, survival_rate) %>%
  arrange(Species, desc(survival_rate))

latest_survival %>%
  kable(caption = "Final Survival Rates by Treatment and Species",
        col.names = c("Treatment", "Species", "Total", "Alive", "Survival Rate (%)"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) 

write.csv(latest_survival,
          file = "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\latest_survival.csv", row.names = FALSE)

# Bar plot of final survival
p_final_survival <- latest_survival %>%
  ggplot(aes(x = Treatment_Name, y = survival_rate, fill = Treatment_Name)) +
  geom_col(alpha = 0.8) +
  # geom_errorbar(aes(ymin = survival_rate - se, ymax = survival_rate),
  #               width = 0.25) +
  facet_wrap(~ Species, labeller = labeller(Species = c("LARA" = "L. racemosa", 
                                                        "RHMA" = "R. mangle"))) +
  scale_fill_manual(values = color_vals) +
  labs(title = "Final Survival Rates by Treatment",
       x = "Treatment",
       y = "Survival Rate (%)",
       fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_final_survival)
```

```{r alive-plants}
#Step 1: make a dataframe that has all alive plants with survivorship percentages
alive_plants <- ALLDATA_clean %>%
  group_by(Species, Treatment_Name, Replicate, Time_Period) %>%
  summarise(
    alive_n = sum(Surv_Bin == 1, na.rm = TRUE),
    total_n = n(),
    alive_pct = (alive_n / total_n) * 100,
    .groups = "drop"
  )%>%
  arrange(Species, Treatment_Name, Time_Period, Replicate)

# Ensure Time_Period is character only in this pipeline (don’t globally change earlier)
tp_dat <- ALLDATA_clean %>%
  mutate(Time_Period_chr = as.character(Time_Period))

# Alive at TP0 and TP6 only
alive_tp0_6 <- tp_dat %>%
  filter(Time_Period_chr %in% c("0","6"), Surv_Bin == 1)

# IDs alive at BOTH endpoints (species-safe)
survivors_both <- alive_tp0_6 %>%
  distinct(Species, Prop_ID, Time_Period_chr) %>%
  count(Species, Prop_ID, name = "n_tp") %>%
  filter(n_tp == 2) %>%
  dplyr::select(Species, Prop_ID)

# Quick counts per species
survivor_counts <- survivors_both %>%
  count(Species, name = "n_survivors")

print(survivor_counts)
# Expect similar to: RHMA ~ 266, LARA ~ 76

# --- Step 3: Separate lists for RHMA and LARA ---------------------------
RHMA_survivors <- survivors_both %>% filter(Species == "RHMA") %>% distinct(Prop_ID)
LARA_survivors <- survivors_both %>% filter(Species == "LARA") %>% distinct(Prop_ID)

# Peek
head(RHMA_survivors); nrow(RHMA_survivors)
head(LARA_survivors); nrow(LARA_survivors)

# Full histories for just those survivors (still no-flags)
survivor_full_history <- ALLDATA_clean %>%
  inner_join(survivors_both, by = c("Species","Prop_ID"))

# Export the full dataset of ALLDATA (all time periods) to CSV
write.csv(survivor_full_history, "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\survivors_tp0-tp6.csv", row.names = FALSE)

```

## *Sargassum* Effect

```{r sargassum-effect}
# Compare treatments by Sargassum presence
treatment_comparison <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period)) %>%
  group_by(Treatment_Name, Sarg_group, Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    se = sqrt(survival_rate * (100 - survival_rate) / n)
  )

p_sarg_effect <- ggplot(treatment_comparison, 
             aes(x = Treatment_Name, y = survival_rate, fill = Treatment_Name)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = survival_rate - se, ymax = survival_rate + se),
                width = 0.25) +
  facet_grid(Species ~ Sarg_group, scales = "free_x", space = "free_x",
             labeller = labeller(Species = c("RHMA" = "R. mangle", 
                                            "LARA" = "L. racemosa"))) +
  scale_fill_manual(values = color_vals) +
  labs(title = "Survival by Sargassum Presence",
       x = "Treatment",
       y = "Survival Rate (%)",
       fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_sarg_effect)

# Summary statistics
sarg_summary <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period)) %>%
  group_by(Sarg_group, Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    se = sqrt(survival_rate * (100 - survival_rate) / n)
  )

sarg_summary %>%
  kable(caption = "Survival by Sargassum Presence",
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Statistical Analysis

## Chi-square Test for Independence

```{r chi-square}
final_data <- ALLDATA_clean %>%
  mutate(Time_Period = parse_number(as.character(Time_Period))) %>%
  filter(Time_Period == max(Time_Period))

# Red mangroves (RHMA)
rhma_data <- final_data %>% filter(Species == "RHMA")
if(nrow(rhma_data) > 0) {
  rhma_contingency <- table(rhma_data$Treatment_Name, rhma_data$Surv_Bin)
  cat("Red Mangroves - Contingency Table:\n")
  print(rhma_contingency)
  
  rhma_chi <- chisq.test(rhma_contingency)
  cat("\nRed Mangroves - Chi-square Test:\n")
  print(rhma_chi)
}

# White mangroves (LARA)
lara_data <- final_data %>% filter(Species == "LARA")
if(nrow(lara_data) > 0) {
  lara_contingency <- table(lara_data$Treatment_Name, lara_data$Surv_Bin)
  cat("\n\nWhite Mangroves - Contingency Table:\n")
  print(lara_contingency)
  
  lara_chi <- chisq.test(lara_contingency)
  cat("\nWhite Mangroves - Chi-square Test:\n")
  print(lara_chi)
}
```

## Logistic Regression

```{r logistic-regression}
# Fit logistic regression model
logit_model <- glm(Surv_Bin ~ Treatment_Name * Species, 
                   data = final_data, 
                   family = binomial(link = "logit"))

cat("Logistic Regression Model Summary:\n")
summary(logit_model)

cat("\n\nAnalysis of Deviance:\n")
anova(logit_model, test = "Chisq")
```

## Post-hoc Comparisons

```{r posthoc}

# Estimated marginal means
emmeans_survival <- emmeans(logit_model, ~ Treatment_Name | Species, type = "response")
cat("Estimated Marginal Means (Survival Probability):\n")
print(summary(emmeans_survival))

# Pairwise within each species
pairs_by <- pairs(emmeans_survival, by = "Species", adjust = "tukey")

# Print both species nicely
summary(pairs_by)                    # log-odds (β) differences
summary(pairs_by, exp = TRUE)        # odds ratios (recommended)

#If you want data frames (easy to filter/report)
pairs_df      <- as.data.frame(summary(pairs_by))
pairs_df_or   <- as.data.frame(summary(pairs_by, exp = TRUE))  # with ORs

# Separate tables:
pairs_lara <- subset(pairs_df_or, Species == "LARA")
pairs_rhma <- subset(pairs_df_or, Species == "RHMA")

```

Re-fit the model using Firth logistif since there was complete
separation due to all the soil and crushed glass surviving for RHMA.
This led to differences in the other 3 not being as apparent though.

```{r}
library(logistf)
library(emmeans)

analyze_species_survival <- function(data, species_name) {
  # Filter for chosen species
  dat_sp <- subset(data, Species == species_name)
  
  # Fit Firth logistic regression with treatment only
  firth_mod <- logistf(Surv_Bin ~ Treatment_Name, data = dat_sp)
  
  # Model summary
  cat("\n===== Results for", species_name, "=====\n")
  print(summary(firth_mod))
  
  # Estimated marginal means (survival probabilities)
  emm <- emmeans(firth_mod, ~ Treatment_Name, type = "response")
  cat("\nEstimated Survival Probabilities:\n")
  print(summary(emm))
  
  # Pairwise comparisons among treatments
  pairs_res <- pairs(emm, adjust = "tukey")
  cat("\nPairwise Comparisons:\n")
  print(summary(pairs_res, exp = TRUE))   # odds ratios
  
  # Return list of objects in case you want to reuse them
  return(list(
    model = firth_mod,
    emmeans = emm,
    pairs = pairs_res
  ))
}

# White mangroves
lara_results <- analyze_species_survival(final_data, "LARA")

# Red mangroves
rhma_results <- analyze_species_survival(final_data, "RHMA")

```

## Mixed Effects Model

This code has the impact of the complete separation caused by the RHMA
survivorship

```{r mixed-model}
# Account for repeated measures and site effects
ALLDATA_model <- ALLDATA_clean %>%
  mutate(Time_num = as.numeric(as.character(Time_Period)))

# Fit mixed effects logistic regression
mixed_model <- glmer(Surv_Bin ~ Treatment_Name + 
                     (1 | Prop_ID) + (1 | Site),
                     data = ALLDATA_model,
                     family = binomial,
                     control = glmerControl(optimizer = "bobyqa"))

cat("Mixed Effects Model Summary:\n")
summary(mixed_model)

cat("\n\nFixed Effects Significance:\n")
anova(mixed_model)
```

Re-run but separate the species

```{r}
# --- White mangroves ---
lara_data <- subset(ALLDATA_model, Species == "LARA")

glmer_lara <- glmer(Surv_Bin ~ Treatment_Name + 
                      (1 | Prop_ID) + (1 | Site),
                    data = lara_data,
                    family = binomial,
                    control = glmerControl(optimizer = "bobyqa"))

summary(glmer_lara)

emm_lara <- emmeans(glmer_lara, ~ Treatment_Name, type = "response")
summary(emm_lara)
pairs(emm_lara, adjust = "tukey")


# --- Red mangroves ---
rhma_data <- subset(ALLDATA_model, Species == "RHMA")

glmer_rhma <- glmer(Surv_Bin ~ Treatment_Name + 
                      (1 | Prop_ID) + (1 | Site),
                    data = rhma_data,
                    family = binomial,
                    control = glmerControl(optimizer = "bobyqa"))

summary(glmer_rhma)

emm_rhma <- emmeans(glmer_rhma, ~ Treatment_Name, type = "response")
summary(emm_rhma)
pairs(emm_rhma, adjust = "tukey")
```

## *Sargassum* Gradient Analysis

```{r sargassum-gradient}
# Analyze Sargassum as continuous predictor
gradient_model <- glm(Surv_Bin ~ SG_pct * Species, 
                      data = final_data,
                      family = binomial)

cat("Sargassum Gradient Model:\n")
summary(gradient_model)

# Visualize gradient effect
gradient_pred <- expand.grid(
  SG_pct = seq(0, 100, by = 5),
  Species = unique(final_data$Species)
)

gradient_pred$pred_survival <- predict(gradient_model, 
                                       newdata = gradient_pred, 
                                       type = "response")

obs_data <- final_data %>%
  group_by(SG_pct, Species, Treatment_Name) %>%
  summarise(obs_survival = mean(Surv_Bin) * 100) %>%
  ungroup()

p_gradient <- ggplot(gradient_pred, aes(x = SG_pct, y = pred_survival * 100)) +
  geom_line(aes(color = Species), size = 1.5, alpha = 0.8) +
  geom_point(data = obs_data,
             aes(y = obs_survival, color = Species, shape = Treatment_Name), 
             size = 4, alpha = 0.9) +
  scale_color_manual(values = c("RHMA" = "#D73502", "LARA" = "#8B7355"),
                    labels = c("RHMA" = "R. mangle", "LARA" = "L. racemosa")) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Survival Rate vs Sargassum Percentage",
       x = "Sargassum Content (%)",
       y = "Survival Rate (%)",
       color = "Species",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "right")

print(p_gradient)
```

## Kaplan-Meier Survival Analysis

I feel like this is important to show how quickly they died across
treatments. However, I need some more clarification on this.

```{r kaplan-meier}
# Prepare data for survival analysis
surv_data <- ALLDATA_clean %>%
  group_by(Species, Prop_ID, Treatment_Name) %>%
  summarise(
    last_alive = max(as.numeric(as.character(Time_Period[Surv_Bin == 1])), na.rm = TRUE),
    final_status = ifelse(any(Surv_Bin == 0), 1, 0),  # 1 = died, 0 = censored
    survival_time = ifelse(final_status == 1, 
                          min(as.numeric(as.character(Time_Period[Surv_Bin == 0])), na.rm = TRUE),
                          max(as.numeric(as.character(Time_Period))))
  ) %>%
  ungroup()

# # Create survival object
# surv_obj <- Surv(time = surv_data$survival_time, event = surv_data$final_status)
# 
# # Fit survival curves
# fit <- survfit(surv_obj ~ Treatment_Name + Species, data = surv_data)
# 
# # Plot Kaplan-Meier curves
# ggsurvplot(fit, 
#            data = surv_data,
#            pval = TRUE,
#            conf.int = TRUE,
#            risk.table = TRUE,
#            risk.table.height = 0.3,
#            palette = "jco",
#            legend.title = "Treatment:Species",
#            title = "Kaplan-Meier Survival Curves")
# 
# fit_lara <- survfit(Surv(survival_time, final_status) ~ Treatment_Name,
#                     data = subset(surv_data, Species == "LARA"))
# fit_rhma <- survfit(Surv(survival_time, final_status) ~ Treatment_Name,
#                     data = subset(surv_data, Species == "RHMA"))

# 1) Shorten labels (add a simple factor just for plotting)
surv_data2 <- surv_data %>%
  mutate(
    Treatment = dplyr::recode(
      Treatment_Name,
      "Soil"                  = "Soil",
      "Crushed glass"         = "CG",
      "25% SG"                = "25% SG",
      "75% SG"                = "75% SG",
      "100% Sargassum (SG)"   = "100% SG"
    ),
    Species          = factor(as.character(Species)),
    Treatment = factor(Treatment,
                              levels = c("Soil", "CG", "25% SG", "75% SG", "100% SG"))
  )

# 2) Fit KM models per species
lara_dat <- droplevels(subset(surv_data2, Species == "LARA"))
rhma_dat <- droplevels(subset(surv_data2, Species == "RHMA"))

fit_lara <- survfit(Surv(survival_time, final_status) ~ Treatment, data = lara_dat)
fit_rhma <- survfit(Surv(survival_time, final_status) ~ Treatment, data = rhma_dat)

# 3) Plot settings (consistent look)
p_lara <- ggsurvplot(
  fit_lara, data = lara_dat,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, risk.table.height = 0.22,
  risk.table.fontsize = 3,
  risk.table.y.text.col = TRUE, risk.table.y.text = FALSE,
  legend.title = "Treatment",
  title = "L. racemosa — Kaplan–Meier",
  palette = "jco"
)

p_rhma <- ggsurvplot(
  fit_rhma, data = rhma_dat,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, risk.table.height = 0.22,
  risk.table.fontsize = 3,
  risk.table.y.text.col = TRUE, risk.table.y.text = FALSE,
  legend.title = "Treatment",
  title = "R. mangle — Kaplan–Meier",
  palette = "jco"
)

# 4) Arrange side-by-side with a shared legend at the bottom
kap_meier_plots<-arrange_ggsurvplots(
  list(p_lara, p_rhma),
  ncol = 2, nrow = 1,
  common.legend = TRUE,
  legend = "bottom"
)
print(kap_meier_plots)

# Save it as PNG
ggsave("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\kap-meier-survival-plots.png", plot = kap_meier_plots, width = 18, height = 8, dpi = 500)

```

# Results Summary

## Treatment Rankings

```{r rankings}
# Rank treatments by survival
survival_ranks <- latest_survival %>%
  group_by(Species) %>%
  arrange(desc(survival_rate)) %>%
  mutate(rank = row_number()) %>%
  dplyr::select(Species, Treatment_Name, survival_rate, rank)

survival_ranks %>%
  kable(caption = "Treatment Rankings by Survival Rate",
        col.names = c("Species", "Treatment", "Survival Rate (%)", "Rank"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(survival_ranks$Treatment_Name == "Soil"), bold = TRUE)
```

## Hypothesis Testing Results

```{r hypothesis-results}
alpha <- 0.05
expected_order <- c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)")

cat(strrep("=", 60), "\n")
cat("HYPOTHESIS TESTING RESULTS\n")
cat(strrep("=", 60), "\n")

# H1: Red mangroves
if(exists("rhma_chi")) {
  cat("Red Mangroves (H₀₁):\n")
  result <- ifelse(rhma_chi$p.value < alpha, 
                  "REJECT null hypothesis - Significant treatment effect",
                  "FAIL TO REJECT null hypothesis - No significant treatment effect")
  cat("  Decision:", result, "\n")
  cat("  p-value:", round(rhma_chi$p.value, 4), "\n")
  
  # Check ranking
  rhma_actual <- survival_ranks %>%
    filter(Species == "RHMA") %>%
    arrange(rank) %>%
    pull(Treatment_Name)
  
  cat("\n  Expected ranking:", paste(expected_order, collapse = " > "), "\n")
  cat("  Actual ranking:  ", paste(rhma_actual, collapse = " > "), "\n")
  cat("  Match:", ifelse(all(rhma_actual == expected_order), "YES ✓", "NO ✗"), "\n\n")
}

# H2: White mangroves
if(exists("lara_chi")) {
  cat("White Mangroves (H₀₂):\n")
  result <- ifelse(lara_chi$p.value < alpha,
                  "REJECT null hypothesis - Significant treatment effect",
                  "FAIL TO REJECT null hypothesis - No significant treatment effect")
  cat("  Decision:", result, "\n")
  cat("  p-value:", round(lara_chi$p.value, 4), "\n")
  
  # Check ranking
  lara_actual <- survival_ranks %>%
    filter(Species == "LARA") %>%
    arrange(rank) %>%
    pull(Treatment_Name)
  
  cat("\n  Expected ranking:", paste(expected_order, collapse = " > "), "\n")
  cat("  Actual ranking:  ", paste(lara_actual, collapse = " > "), "\n")
  cat("  Match:", ifelse(all(lara_actual == expected_order), "YES ✓", "NO ✗"), "\n")
}
```

## Key Findings

```{r key-findings}
# Overall survival statistics
cat("OVERALL SURVIVAL STATISTICS:\n\n")

overall_stats <- final_data %>%
  group_by(Treatment_Name) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100,
    alive = sum(Surv_Bin),
    dead = n - alive
  ) %>%
  arrange(desc(survival_rate))

overall_stats %>%
  kable(caption = "Overall Survival by Treatment (Both Species Combined)",
        col.names = c("Treatment", "N", "Survival %", "Alive", "Dead"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Sargassum effect
cat("\n\nSARGASSUM EFFECT:\n")
sarg_effect <- final_data %>%
  group_by(Sarg_group) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100
  )

effect_size <- diff(sarg_effect$survival_rate)
cat("Difference (No Sargassum - With Sargassum):", round(effect_size, 2), "%\n")

# Species comparison
cat("\n\nSPECIES COMPARISON:\n")
species_stats <- final_data %>%
  group_by(Species) %>%
  summarise(
    n = n(),
    survival_rate = mean(Surv_Bin) * 100
  )

species_stats %>%
  kable(caption = "Overall Survival by Species",
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Conclusions

Based on the comprehensive survivorship analysis:

1.  **Treatment Effects**: Statistical tests reveal whether substrate
    type significantly affects survivorship in both red and white
    mangroves.

2.  **Hypothesis Support**: The analysis evaluates whether the
    hypothesized ranking (Soil \> Crushed glass \> 25% SG \> 75% SG \>
    100% *Sargassum*) is supported by the data.

3.  ***Sargassum*** **Impact**: Clear evidence shows the negative effect
    of *Sargassum* presence on seedling survival, with a dose-dependent
    response.

4.  **Species-Specific Responses**: The analysis reveals whether red and
    white mangroves respond differently to the treatments.

5.  **Practical Implications**: Results suggest that traditional potting
    soil remains the optimal substrate for mangrove restoration, while
    *Sargassum*-containing substrates should be avoided or minimized.

Based on the statistical analyses:

## Survivorship Findings

### Red Mangroves (*Rhizophora mangle*)

**Hypothesis Testing:** - **Null Hypothesis 1**: There is no difference
in survivorship of red mangrove seedlings regardless of treatment. -
**Results**: [To be filled based on your actual results] - Overall
treatment effect: [Significant/Not significant] (p = [value]) -
Treatment ranking observed: [List actual order from your data] -
Expected ranking: Soil \> Crushed glass \> 75% SG \> 25% SG \> 100%
*Sargassum* (SG) -Actual RHMA ranking: Soil \> Crushed glass \> 75% SG
\> 100% *Sargassum* (SG) \> 25% SG -Actual LARA ranking: Soil \> Crushed
glass \> 75% SG \> 25% SG \> 100% *Sargassum* (SG) - Survival curve
differences: [Significant/Not significant] (Log-rank p = [value])

**Key Survivorship Findings for Red Mangroves:** - [Interpret whether
soil performed best as hypothesized] - [Describe *Sargassum* gradient
effects on survival] - [Note any unexpected survival patterns] -
[Comment on timing of mortality if relevant]

### White Mangroves (*Laguncularia racemosa*)

**Hypothesis Testing:** - **Null Hypothesis 2**: There is no difference
in survivorship of white mangrove propagules regardless of substrate
type. - **Results**: [To be filled based on your actual results] -
Overall treatment effect: [Significant/Not significant] (p = [value]) -
Treatment ranking observed: [List actual order from your data] -
Expected ranking: Soil \> Crushed glass \> 75% SG \> 25% SG \> 100%
*Sargassum* (SG) - Survival curve differences: [Significant/Not
significant] (Log-rank p = [value])

**Key Survivorship Findings for White Mangroves:** - [Interpret whether
soil performed best as hypothesized] - [Describe *Sargassum* gradient
effects on survival] - [Note any species-specific survival responses] -
[Comment on timing of mortality if relevant]

## Sargassum Effects on Survivorship

**Gradient Analysis:** - ***Sargassum*** **percentage effect on Red
mangrove survival**: [Linear relationship present/absent] -
***Sargassum*** **percentage effect on White mangrove survival**:
[Linear relationship present/absent] - ***Sargassum*** **presence vs
absence on survival**: [Beneficial/Detrimental/No effect] - **Optimal
*Sargassum* concentration**: [25%/75%/100% or none]

## Species Survivorship Comparisons

-   **Overall survival differences**: [Compare red vs white performance
    across treatments]
-   **Treatment-specific survival differences**: [Species responses
    within each treatment]
-   **Interaction effects**: [Whether species respond differently to
    treatments]
-   **Mortality timing**: [Early vs late mortality patterns by species]

## Survival Curve Analysis

-   **Time-to-event patterns**: [Describe when mortality occurred in
    different treatments]
-   **Treatment separation**: [When survival curves diverged]
-   **Risk periods**: [Identify high-mortality time periods]

## Hypothesis Conclusions

### Null Hypothesis 1 (Red mangroves): **[ACCEPT/REJECT]**

**Rationale**: [Based on statistical significance and effect sizes]

### Null Hypothesis 2 (White mangroves): **[ACCEPT/REJECT]**

**Rationale**: [Based on statistical significance and effect sizes]

## Ecological Implications

**For Mangrove Restoration:** - [Recommend best substrate based on
results] - [Discuss cost-benefit of different treatments] - [Consider
species-specific recommendations]

**Sargassum Utilization:** - [Evaluate potential for *Sargassum* use in
restoration] - [Discuss optimal Sargassum concentrations if
beneficial] - [Consider environmental benefits of *Sargassum* recycling]

**Study Limitations:** - [Note any data quality issues, sample size
limitations] - [Discuss temporal scale and environmental factors] -
[Suggest future research directions]

## Recommendations

1.  **For Red Mangrove Restoration**: [Specific substrate
    recommendation]
2.  **For White Mangrove Restoration**: [Specific substrate
    recommendation]\
3.  ***Sargassum*** **Management**: [Recommendations for *Sargassum*
    use]
4.  **Future Research**: [Suggest long-term studies, additional factors
    to investigate]

------------------------------------------------------------------------

*Analysis completed with
`r nrow(distinct(ALLDATA_clean, Species, Prop_ID))` unique plants across
`r length(unique(ALLDATA_clean$Treatment_Name))` treatments over
`r length(unique(ALLDATA_clean$Time_Period))` time periods. Quality
control removed `r nrow(flagged_ids)` plants with data inconsistencies.*

# Session Information

```{r session-info} sessionInfo()}
```
