---
title: "Alive Survivorship Over Time (Replicate-Level)"
author: "Sarai Hutchinson"
date: "2025-08-30"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
---

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(viridis)
library(ggplot2)
library(ggplot2)

# Color palettes
okabe_ito <- c("#009E73", "#D55E00", "#E69F00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7")
viridis_palette <- viridis(8)
```


```{r data-import}
# Read data
ALLDATA <- read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/Hutchinson_MonitoringAndIntake_Sites.csv")

# Inspect structure (optional)
# str(ALLDATA)

# Clean treatment labels (ordered for legend)
ALLDATA <- ALLDATA %>%
  mutate(
    Treatment_Name = case_when(
      Treatment == "A" ~ "Soil",
      Treatment == "B" ~ "Crushed glass (CG)",
      Treatment == "C" ~ "Sargassum only (SG)",
      Treatment == "D" ~ "3:1 CG to SG",
      Treatment == "E" ~ "1:3 CG to SG",
      TRUE ~ as.character(Treatment)
    ),
    Treatment_Name = factor(
      Treatment_Name,
      levels = c("Soil", "Crushed glass (CG)", "3:1 CG to SG", "1:3 CG to SG", "Sargassum only (SG)") #ordered it so that it goes from least Sargassum to most Sargassum additions
    )
  )

# ---- Derive Sargassum indicators from your new Treatment_Name labels ----
ALLDATA <- ALLDATA %>%
  mutate(
    # Presence/absence (for simple contrasts)
    Sarg_present = if_else(
      Treatment_Name %in% c("3:1 CG to SG", "1:3 CG to SG", "Sargassum only (SG)"),
      1L, 0L
    ),
    Sarg_group = factor(if_else(Sarg_present == 1L, "With Sargassum", "No Sargassum"),
                        levels = c("No Sargassum","With Sargassum")),

    # Simple gradient coding you can use as a numeric predictor
    SG_pct = case_when(
      Treatment_Name == "Soil"               ~ 0,
      Treatment_Name == "Crushed glass (CG)" ~ 0,
      Treatment_Name == "3:1 CG to SG"       ~ 25,  # light Sargassum
      Treatment_Name == "1:3 CG to SG"       ~ 75,  # heavy Sargassum
      Treatment_Name == "Sargassum only (SG)"~ 100, # all Sargassum
      TRUE ~ NA_real_
    )
  )

ALLDATA_SurvBin <- ALLDATA %>%
  mutate(
    Surv_Bin = ifelse(Survivorship %in% c("A", "DY"), 1, 0),
    Time_Period = factor(Time_Period, levels = c("0", "1", "2", "3", "4", "5", "6")),
    Species = factor(Species))
  
```

```{r Resurrections-QC}
# ---- QC: 0→1 resurrections (factor-safe time order) ----
qc_resurrections <- ALLDATA_SurvBin %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%   # <- robust
  arrange(Species, Prop_ID, TP_num) %>%
  group_by(Species, Prop_ID) %>%
  mutate(change = Surv_Bin - lag(Surv_Bin)) %>%
  filter(change == 1 & lag(Surv_Bin) == 0) %>%  # 0 → 1 transition (= resurrection)
  ungroup()

flagged_ids <- qc_resurrections %>% distinct(Species, Prop_ID)

ALLDATA_no_flags <- ALLDATA_SurvBin %>%
  anti_join(flagged_ids, by = c("Species","Prop_ID"))


```



## Creating list with the ALLDATA at tp1 and tp6
```{r tp0-6}
#Step 1: make a dataframe that has all alive plants with survivorship percentages
alive_plants <- ALLDATA_no_flags %>%
  group_by(Species, Treatment_Name, Replicate, Time_Period) %>%
  summarise(
    alive_n = sum(Surv_Bin == 1, na.rm = TRUE),
    total_n = n(),
    alive_pct = (alive_n / total_n) * 100,
    .groups = "drop"
  )%>%
  arrange(Species, Treatment_Name, Time_Period, Replicate)

```


```{r TotalSurvivorship}
# --- 1) All replicates over time --------------------------------------
# --- 2) Mean ± SE by treatment over time -------------------------------
alive_summary <- alive_plants %>%
  group_by(Species, Treatment_Name, Time_Period) %>%
  summarise(
    mean_alive = mean(alive_pct, na.rm = TRUE),
    se_alive   = sd(alive_pct, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# ----- define shapes for each Treatment_Name (match your factor levels) -----
shape_vals <- c(
  "Soil"               = 0, # open square
  "Crushed glass (CG)" = 17, # filled triangle
  "Sargassum only (SG)"= 15, # filled square
  "3:1 CG to SG"       = 18, # filled diamond
  "1:3 CG to SG"       = 8   # asterick
)

ggplot(alive_summary,
       aes(x = Time_Period, y = mean_alive, color = Treatment_Name, shape = Treatment_Name, group = Treatment_Name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_alive - se_alive,
                    ymax = mean_alive + se_alive),
                width = 0.2) +
  facet_wrap(~Species) +
  labs(
    title = "Mean % Alive per Treatment (±SE) across Time Periods",
    x = "Month", y = "Mean % Alive"
  ) +
  scale_color_manual(values = okabe_ito, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  theme_bw(base_size = 12)
```
```{r Survivorship-TP6}
# --- Filter to TP6 only ---
alive_tp6 <- alive_summary %>%
  filter(Time_Period == "6")

# --- Option A: Bar plot with error bars ---
ggplot(alive_tp6,
       aes(x = Treatment_Name, y = mean_alive,
           fill = Treatment_Name)) +
  geom_col(position = position_dodge(), color = "black") +
  geom_errorbar(aes(ymin = mean_alive - se_alive,
                    ymax = mean_alive + se_alive),
                width = 0.2) +
  facet_wrap(~Species) +
  labs(
    title = "Percent Alive at Month 6 by Treatment",
    x = "Treatment", y = "Mean % Alive (±SE)"
  ) +
  scale_fill_manual(values = okabe_ito, name = "Treatment") +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

# --- Option B: Dot + error bar plot ---
ggplot(alive_tp6,
       aes(x = Treatment_Name, y = mean_alive,
           color = Treatment_Name, shape = Treatment_Name)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_alive - se_alive,
                    ymax = mean_alive + se_alive),
                width = 0.2) +
  facet_wrap(~Species) +
  labs(
    title = "Percent Alive at Month 6 by Treatment",
    x = "Treatment", y = "Mean % Alive (±SE)"
  ) +
  scale_color_manual(values = okabe_ito, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

```

```{r Survivorship-plots2}

# --- Data for overlays: replicate-level points at TP6 ---
alive_tp6_reps <- alive_plants %>%
  filter(Time_Period == "6")

# --- Summary already computed above; filter to TP6 for the summaries ---
alive_tp6 <- alive_summary %>% 
  filter(Time_Period == "6")

# ========== OPTION A: BAR + ERROR BARS + JITTERED REPLICATE DOTS ==========
ggplot(alive_tp6,
       aes(x = Treatment_Name, y = mean_alive, fill = Treatment_Name)) +
  geom_col(color = "black") +
  geom_errorbar(aes(ymin = mean_alive - se_alive,
                    ymax = mean_alive + se_alive),
                width = 0.2) +
  # raw replicate dots (slight horizontal jitter, no legend)
  geom_jitter(data = alive_tp6_reps,
              aes(y = alive_pct, x = Treatment_Name, color = Treatment_Name),
              width = 0.12, height = 0, alpha = 0.7, size = 1.9, show.legend = FALSE) +
  facet_wrap(~Species) +
  scale_fill_manual(values = okabe_ito, name = "Treatment") +
  scale_color_manual(values = okabe_ito, guide = "none") +
  coord_cartesian(ylim = c(0, 100)) +
  labs(
    title = "Percent Alive at Month 6 by Treatment (bars = mean ± SE; dots = replicates)",
    x = "Treatment", y = "Mean % Alive (±SE)"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

# ========== OPTION B: DOT + ERROR BARS + JITTERED REPLICATE DOTS ==========
ggplot(alive_tp6,
       aes(x = Treatment_Name, y = mean_alive,
           color = Treatment_Name, shape = Treatment_Name, group = Treatment_Name)) +
  # raw replicate dots behind the summary (slightly lighter)
  geom_jitter(data = alive_tp6_reps,
              aes(y = alive_pct, x = Treatment_Name, color = Treatment_Name),
              width = 0.12, height = 0, alpha = 0.5, size = 1.8, show.legend = FALSE) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_alive - se_alive,
                    ymax = mean_alive + se_alive),
                width = 0.2) +
  facet_wrap(~Species) +
  scale_color_manual(values = okabe_ito, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  coord_cartesian(ylim = c(0, 100)) +
  labs(
    title = "Percent Alive at Month 6 by Treatment (points = mean ± SE; dots = replicates)",
    x = "Treatment", y = "Mean % Alive (±SE)"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

```

```{r tp0-6}
# Ensure Time_Period is character only in this pipeline (don’t globally change earlier)
tp_dat <- ALLDATA_no_flags %>%
  mutate(Time_Period_chr = as.character(Time_Period))

# Alive at TP0 and TP6 only
alive_tp0_6 <- tp_dat %>%
  filter(Time_Period_chr %in% c("0","6"), Surv_Bin == 1)

# IDs alive at BOTH endpoints (species-safe)
survivors_both <- alive_tp0_6 %>%
  distinct(Species, Prop_ID, Time_Period_chr) %>%
  count(Species, Prop_ID, name = "n_tp") %>%
  filter(n_tp == 2) %>%
  select(Species, Prop_ID)

# Quick counts per species
survivor_counts <- survivors_both %>%
  count(Species, name = "n_survivors")

print(survivor_counts)
# Expect similar to: RHMA ~ 266, LARA ~ 76

# --- Step 3: Separate lists for RHMA and LARA ---------------------------
RHMA_survivors <- survivors_both %>% filter(Species == "RHMA") %>% distinct(Prop_ID)
LARA_survivors <- survivors_both %>% filter(Species == "LARA") %>% distinct(Prop_ID)

# Peek
head(RHMA_survivors); nrow(RHMA_survivors)
head(LARA_survivors); nrow(LARA_survivors)

# Full histories for just those survivors (still no-flags)
survivor_full_history <- ALLDATA_no_flags %>%
  inner_join(survivors_both, by = c("Species","Prop_ID"))

# Cohort survival over time, by treatment (uses your new Treatment_Name levels)
cohort_survival <- survivor_full_history %>%
  group_by(Species, Treatment_Name, Time_Period) %>%
  summarise(alive_pct = mean(Surv_Bin == 1, na.rm = TRUE) * 100, .groups = "drop")

# Plot: mean % alive over time for the survivor cohort
# This just shows that any weird zombie plants were removed from the final numbers.
ggplot(cohort_survival,
       aes(x = Time_Period, y = alive_pct,
           color = Treatment_Name, group = Treatment_Name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  facet_wrap(~Species) +
  scale_color_manual(values = okabe_ito, name = "Treatment") +
  coord_cartesian(ylim = c(0, 100)) +
  labs(
    title = "Cohort Survival (Alive at TP0 and TP6)",
    subtitle = "Percent alive across time, endpoints cohort, zombies removed",
    x = "Month", y = "% Alive"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1),
        strip.text = element_text(face = "bold"))

# --- (Optional) sanity check: counts by treatment at TP6 for this cohort
tp6_counts <- survivor_full_history %>%
  filter(Time_Period == "6") %>%
  group_by(Species, Treatment_Name) %>%
  summarise(n_survivors = n_distinct(Prop_ID), .groups = "drop") %>%
  arrange(Species, Treatment_Name)

print(tp6_counts)

```
## Statistical Analyses
```{r StatsPackages-data}
# ---- Packages ----
library(tidyverse)
library(lme4)         # GLMM (binomial)
library(glmmTMB)      # alt GLMM + beta-binomial (overdispersion)
library(emmeans)      # marginal means & contrasts
library(broom.mixed)  # tidy model outputs
library(DHARMa)       # residual/overdispersion checks
library(survival)     # KM + Cox
# library(survminer)  # pretty KM plots (optional)
# library(coxme)      # Cox mixed (random effects) alternative

dat <- ALLDATA_no_flags %>%
  mutate(
    TP_num = as.integer(as.character(Time_Period)),
    # once-dead-always-dead (applied again here in case you model on this object)
    Surv_Bin_clean = ave(Surv_Bin, Species, Prop_ID,
                         FUN = function(x) ifelse(cummin(x) == 0, 0L, 1L))
  )
```


```{r Data-Distribution}
# 1) What are the underlying distributions?
# 
# Binary survivorship ⇒ binomial. Check dispersion and residuals; if overdispersed, consider beta-binomial (glmmTMB).
m_treat <- glmer(
  Surv_Bin_clean ~ Treatment_Name + Time_Period + Species + (1|Site),
  data = dat, family = binomial
)

sim_m_treat <- simulateResiduals(m_treat, n = 1000)
plot(sim_m_treat)                 # uniformity/outliers/dispersion
testDispersion(sim_m_treat)       # overdispersion test
```
Dispersion ≈ 0.9 → very close to 1.

p-value = 0.128 (ns) → no evidence of overdispersion (or underdispersion).

* plot looks skewed to the right

That means your binomial GLMM is appropriate, and you don’t need beta-binomial or OLRE here.

What it means for your analysis:

You can proceed with this model (m_treat) for inference.

Next steps: use emmeans to extract treatment comparisons, Sargassum effects, and species-specific contrasts.

```{r Sarg}
# Presence/absence of Sargassum
m_sarg <- glmer(
  Surv_Bin_clean ~ Sarg_present + Time_Period + Species + (1|Site),
  data = dat, family = binomial
)

emmeans(m_sarg, ~ Sarg_present | Species, type = "response")
```


```{r SpeciesContrasts}
# Species-specific contrasts
emm_treat <- emmeans(m_treat, ~ Treatment_Name | Species, type = "response")

# Look at estimated survival probabilities
emm_treat

# Pairwise comparisons (adjusted p-values)
pairs(emm_treat, adjust = "tukey")
```
Awesome — here’s a clean, drop-in workflow to build a **time-to-event dataset** from your long data and run **Kaplan–Meier curves** + a **Cox model with Site frailty** to answer “do some treatments have faster/slower deaths?” (Q4). It uses your existing objects (`dat` with `Surv_Bin_clean`, `Species`, `Treatment_Name`, `Site`, `Prop_ID`, `Time_Period`).

```{r}
# ---- Packages ----
library(broom)         # tidy() for coxph
# Optional pretty KM plots:
library(survminer)

# ---- 1) Build one-row-per-plant survival dataset ----------------------
# Assumes dat has:
#   - Surv_Bin_clean (1=alive, 0=dead) after "once-dead-always-dead"
#   - Time_Period as factor "0"..."6"
#   - Species, Treatment_Name, Site, Replicate, Prop_ID

surv_dat <- dat %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%
  arrange(Species, Prop_ID, TP_num) %>%
  group_by(Species, Site, Replicate, Treatment_Name, Prop_ID) %>%
  summarise(
    # first time a 0 appears (death); subtract 1 so time reflects last alive TP
    death_idx = { idx <- which(Surv_Bin_clean == 0); if (length(idx)) min(idx) else NA_integer_ },
    time      = ifelse(is.na(death_idx), max(TP_num, na.rm = TRUE), death_idx - 1L),
    event     = as.integer(!is.na(death_idx)),   # 1=death observed, 0=censored
    .groups = "drop"
  )

# Quick sanity checks
table(surv_dat$event, surv_dat$Species)
table(surv_dat$Treatment_Name, useNA = "ifany")


# Ensure "once-dead-always-dead"
dat_clean <- dat %>%
  arrange(Species, Prop_ID, as.integer(as.character(Time_Period))) %>%
  group_by(Species, Prop_ID) %>%
  mutate(Surv_Bin_strict = ifelse(cummin(Surv_Bin_clean) == 0, 0L, 1L)) %>%
  ungroup()

# Collapse to time-to-event
surv_dat <- dat_clean %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%
  group_by(Species, Site, Replicate, Treatment_Name, Prop_ID) %>%
  summarise(
    death_idx = { idx <- which(Surv_Bin_strict == 0);
                  if (length(idx)) min(idx) else NA_integer_ },
    time      = ifelse(is.na(death_idx), max(TP_num, na.rm = TRUE), death_idx - 1L),
    event     = as.integer(!is.na(death_idx)),
    .groups = "drop"
  )

# Check again
table(surv_dat$event, surv_dat$Species)
table(surv_dat$Treatment_Name, surv_dat$Species)

```
```{r}
# ---- 2) Kaplan–Meier curves ------------------------------------------
# Curves by Treatment within Species (one facet per species in survminer; base plots below)
fit_km <- survfit(Surv(time, event) ~ Species + Treatment_Name, data = surv_dat)

# Base R plot (two panels: one per species)
par(mfrow = c(1,2))
for (sp in levels(surv_dat$Species)) {
  plot(
    survfit(Surv(time, event) ~ Treatment_Name, data = subset(surv_dat, Species == sp)),
    main = paste("KM Survival by Treatment —", sp),
    xlab = "Time Period (months)", ylab = "Survival probability", conf.int = TRUE,
    mark.time = TRUE
  )
  legend("bottomleft", legend = levels(surv_dat$Treatment_Name), lty = 1:5, bty = "n")
}
par(mfrow = c(1,1))

# Log-rank tests within each species
for (sp in levels(surv_dat$Species)) {
  cat("\nLog-rank test for", sp, "\n")
  print(survdiff(Surv(time, event) ~ Treatment_Name, data = subset(surv_dat, Species == sp)))
}

# Optional (prettier) with survminer:
# ggsurvplot(
#   fit = survfit(Surv(time, event) ~ Treatment_Name, data = surv_dat),
#   data = surv_dat, facet.by = "Species", conf.int = TRUE, censor = TRUE,
#   risk.table = TRUE, xlab = "Time Period (months)", ylab = "Survival probability"
# )

# Median survival by group (if reachable in your 0–6 window)
km_tbl <- summary(fit_km)$table
km_medians <- tibble::as_tibble(km_tbl, rownames = "Group")
km_medians
```

```{r}
# ---- 3) Cox model: faster/slower deaths (hazard ratios) ---------------
# Site as a shared frailty (random effect); Treatment × Species interaction
cox1 <- coxph(
  Surv(time, event) ~ Treatment_Name * Species + frailty(Site),
  data = surv_dat, ties = "efron"
)
summary(cox1)  # HRs are exp(coef)

# PH (proportional hazards) assumption checks
ph <- cox.zph(cox1)   # Schoenfeld residual tests
print(ph)
# plot(ph)   # inspect any lines with clear slope (violations)

# Tidy HR table (vs the reference levels: Soil and first Species level)
hr_tbl <- broom::tidy(cox1, exponentiate = TRUE, conf.int = TRUE)
hr_tbl[ , c("term","estimate","conf.low","conf.high","p.value")]
```

```{r}
# ---- 4) Species-specific hazard ratios for Sargassum presence (optional) ----
# If you created Sarg_present (0/1) earlier:
cox_sarg <- coxph(
  Surv(time, event) ~ Sarg_present * Species + frailty(Site),
  data = surv_dat %>% mutate(
    Sarg_present = ifelse(Treatment_Name %in% c("3:1 CG to SG","1:3 CG to SG","Sargassum only (SG)"), 1L, 0L)
  ),
  ties = "efron"
)
summary(cox_sarg)
broom::tidy(cox_sarg, exponentiate = TRUE, conf.int = TRUE) %>%
  dplyr::select(term, estimate, conf.low, conf.high, p.value)
```

```{r}
# ---- 5) If PH is violated: two easy remedies --------------------------
# A) Stratify on the offending factor (lets baseline hazard differ)
#    Example: allow different baselines by Species but keep Treatment effects common:
cox_strat <- coxph(
  Surv(time, event) ~ Treatment_Name + strata(Species) + frailty(Site),
  data = surv_dat, ties = "efron"
)

# B) Allow time-varying effects for Treatment (if needed)
#    Here we let treatment effects interact with log(time):
cox_tv <- coxph(
  Surv(time, event) ~ Treatment_Name + tt(Treatment_Name) + Species + frailty(Site),
  data = surv_dat, ties = "efron",
  tt = function(x, t, ...) x * log1p(t)   # example transformation
)
```

### How to read the results

* **KM curves**: Lower curves (dropping faster) = faster deaths. Clear separation between treatments indicates differences in survival.
* **Log-rank test**: Global test of equality across treatment curves (per species).
* **Cox model**:

  * `exp(coef)` (estimate in `hr_tbl`) is the **hazard ratio (HR)** vs the reference (Soil within the reference species).
  * **HR > 1** → faster death than the reference; **HR < 1** → slower death.
  * Use the interaction terms (`Treatment_Name:Species`) to see if treatment effects differ between species.

If you want, I can also generate a compact **report table** (CSV) with per-species HRs vs Soil and a small **KM figure** faceted by species.

