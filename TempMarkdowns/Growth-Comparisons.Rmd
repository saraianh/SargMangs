---
title: "Growth Comparisons"
author: "Sarai Hutchinson"
date: "2025-09-01"
output:
  html_document:
    toc: true
    toc_depth: 6
params:
  export_dir: "exports"
---

##Plot change in height instead of total height
##How long does it take for a plant to die from sulfides?

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(viridis)
library(janitor)
library(lme4)

# Color palettes
okabe_ito <- c("#009E73", "#D55E00", "#E69F00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7")
viridis_palette <- viridis(8)
```

---

### 1. Load & Clean

```{r}
surv <- readr::read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\OutputData\\survivors_tp0-tp6.csv",
                        guess_max = 10000, show_col_types = FALSE) %>%
  clean_names()

surv <- surv%>%
  mutate(
treatment_name = factor(
      treatment_name,
      levels = c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)"))) #ordered it so that it goes from least Sargassum to most Sargassum additions
      
# Coerce to numeric safely
num_cols <- c("rhma_height_1","rhma_height_2","rhma_epi_length",
              "lara_height_1","lara_height_2","number_branches")
num_cols <- intersect(num_cols, names(surv))

surv <- surv %>%
  mutate(across(all_of(num_cols), ~ suppressWarnings(as.numeric(.x))))

# Ensure time_period is numeric
surv <- surv %>%
  mutate(across(all_of(num_cols), ~ suppressWarnings(as.numeric(.x))),
         time_period = suppressWarnings(as.numeric(time_period)),
         monitor_date = suppressWarnings(ymd(date_monitored)),
         uploaded_date = suppressWarnings(ymd(date_uploaded)))

# ----- define shapes for each Treatment_Name (match your factor levels) -----
shape_vals <- c(
  "Soil"               = 0, # open square
  "Crushed glass" = 17, # filled triangle
  "100% Sargassum (SG)"= 15, # filled square
  "25% SG"       = 18, # filled diamond
  "75% SG"       = 8   # asterick
)

# Uses your okabe_ito vector (7 colors). Pick 5 distinct hues.
color_vals <- c(
  "Soil"                = okabe_ito[1], # green  (#009E73)
  "Crushed glass"       = okabe_ito[6], # blue   (#0072B2)
  "25% SG"              = okabe_ito[3], # orange (#E69F00)
  "75% SG"              = okabe_ito[2], # vermil (#D55E00)
  "100% Sargassum (SG)" = okabe_ito[7]  # purple (#CC79A7)
)
```

---

```{r duplicates-check}
# Duplicates per plant-time
dups <- surv %>%
  count(species, treatment_name, prop_id, time_period, sort = TRUE) %>%
  filter(n > 1)
dups %>% print(n = 40)

# Temporary total heights to check non-positive values
surv_chk <- surv %>%
  mutate(
    total_height_substrate_cm = case_when(
      species == "RHMA" ~ rhma_height_1 + rhma_epi_length,
      species == "LARA" ~ lara_height_1,
      TRUE ~ NA_real_
    ),
    total_height_pot_cm = case_when(
      species == "RHMA" ~ rhma_height_2 + rhma_epi_length,
      species == "LARA" ~ lara_height_2,
      TRUE ~ NA_real_
    ),
    total_height_mean_cm = {
      m <- cbind(total_height_substrate_cm, total_height_pot_cm)
      x <- rowMeans(m, na.rm = TRUE)
      ifelse(is.nan(x), NA_real_, x)
    }
  )

surv_chk %>%
  filter(!is.na(total_height_mean_cm), total_height_mean_cm <= 0) %>%
  count(species, treatment_name, time_period, sort = TRUE) %>%
  print(n = 40)

```


### 2. Total Heights (substrate, pot, mean, change between tp0 and tp6)

I tried doing this with the height above substrate and the height above pot plus the epicotyl height for the RHMA but that proved to be unwise. The values are misleading since I failed to measure the height from the substrate to the top of the pot.

```{r total-heights}
surv <- surv %>%
  mutate(
    total_height_substrate_cm = case_when(
      species == "RHMA" ~ rhma_height_1 + rhma_epi_length,
      species == "LARA" ~ lara_height_1,
      TRUE ~ NA_real_
    ),
    total_height_pot_cm = case_when(
      species == "RHMA" ~ rhma_height_2 + rhma_epi_length,
      species == "LARA" ~ lara_height_2,
      TRUE ~ NA_real_
    ),
    total_height_mean_cm = {
      m <- cbind(total_height_substrate_cm, total_height_pot_cm)
      x <- rowMeans(m, na.rm = TRUE)
      ifelse(is.nan(x), NA_real_, x)
    }
  )

surv_use <- surv %>% filter(!is.na(time_period))

# --- Calculate change between TP0 and TP6 ---
height_change <- surv_use %>%
  filter(time_period %in% c(0, 6)) %>%
  select(prop_id, species, treatment_name, time_period, total_height_mean_cm) %>%
  pivot_wider(
    names_from = time_period,
    values_from = total_height_mean_cm,
    names_prefix = "TP"
  ) %>%
  mutate(
    height_change_tp0_tp6 = TP6 - TP0
  )

# 2) otherwise, keep as-is (assumes one row per prop_id × time_period)
surv_use <- surv %>% filter(time_period %in% c(0, 6))

height_change_tp0_tp6 <- surv_use %>%
  select(prop_id, species, treatment_name, time_period,
         total_height_substrate_cm, total_height_pot_cm) %>%
  pivot_wider(
    names_from  = time_period,
    values_from = c(total_height_substrate_cm, total_height_pot_cm),
    names_glue  = "{.value}_TP{time_period}"
  ) %>%
  mutate(
    d_substrate_cm = total_height_substrate_cm_TP6 - total_height_substrate_cm_TP0,
    d_pot_cm       = total_height_pot_cm_TP6       - total_height_pot_cm_TP0
  )

delta_summary <- height_change_tp0_tp6 %>%
  group_by(species, treatment_name) %>%
  summarise(
    n              = dplyr::n(),
    mean_d_sub_cm  = mean(d_substrate_cm, na.rm = TRUE),
    sd_d_sub_cm    = sd(d_substrate_cm,   na.rm = TRUE),
    mean_d_pot_cm  = mean(d_pot_cm,       na.rm = TRUE),
    sd_d_pot_cm    = sd(d_pot_cm,         na.rm = TRUE),
    .groups = "drop"
  )
```

```{r height-change-plots}
# Substrate
ggplot(delta_summary,
       aes(x = treatment_name, y = mean_d_sub_cm,
           fill = species)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_d_sub_cm - sd_d_sub_cm,
                    ymax = mean_d_sub_cm + sd_d_sub_cm),
                width = 0.2,
                position = position_dodge()) +
  geom_text(aes(label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3) +
  labs(
    title = "Height Change Above Substrate (TP6 - TP0)",
    x = "Treatment",
    y = "Height Change (cm)"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Pot
ggplot(delta_summary,
       aes(x = treatment_name, y = mean_d_pot_cm,
           fill = species)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_d_pot_cm - sd_d_pot_cm,
                    ymax = mean_d_pot_cm + sd_d_pot_cm),
                width = 0.2,
                position = position_dodge()) +
  geom_text(aes(label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3) +
  labs(
    title = "Height Change Above Pot (TP6 - TP0)",
    x = "Treatment",
    y = "Height Change (cm)"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Show Height changes overtime
## Step 1. Compute stepwise changes per propagule

```{r}
library(dplyr)

# Start from your surv dataset with heights already calculated and it should have all the time_periods and not just tp0 and tp6 like surv_use
height_steps <- surv %>%
  filter(!is.na(time_period)) %>%
  select(prop_id, species, treatment_name, time_period,
         total_height_substrate_cm, total_height_pot_cm) %>%
  arrange(prop_id, time_period) %>%
  group_by(prop_id, species, treatment_name) %>%
  mutate(
    d_sub_cm = total_height_substrate_cm - lag(total_height_substrate_cm),
    d_pot_cm = total_height_pot_cm       - lag(total_height_pot_cm),
    interval_start = lag(time_period),
    interval_end   = time_period
  ) %>%
  ungroup() %>%
  filter(!is.na(d_sub_cm), !is.na(d_pot_cm)) %>%
  mutate(time_point = interval_end)   # assign to the ending TP
```

This gives you **stepwise changes per plant**. Example `interval`: `"TP0_to_TP1"`, `"TP1_to_TP2"`, etc.

---

## Step 2. Summarise by species × treatment × time point

```{r}
# Summarise by species × treatment × time point
step_summary <- height_steps %>%
  group_by(species, treatment_name, time_point) %>%
  summarise(
    n              = n(),
    mean_d_sub_cm  = mean(d_sub_cm, na.rm = TRUE),
    sd_d_sub_cm    = sd(d_sub_cm,   na.rm = TRUE),
    mean_d_pot_cm  = mean(d_pot_cm, na.rm = TRUE),
    sd_d_pot_cm    = sd(d_pot_cm,   na.rm = TRUE),
    .groups = "drop"
  )
```

---

## Step 3. Line plot

To plot as a line graph across intervals, add a baseline and reshape to long format:

```{r}
library(tidyr)
library(ggplot2)

# Add baseline at TP0 (0 change)
baseline <- step_summary %>%
  distinct(species, treatment_name) %>%
  mutate(time_point = 0,
         n = NA,
         mean_d_sub_cm = 0,
         sd_d_sub_cm   = 0,
         mean_d_pot_cm = 0,
         sd_d_pot_cm   = 0)

step_summary <- bind_rows(baseline, step_summary) %>%
  arrange(species, treatment_name, time_point)


plot_step <- step_summary %>%
  pivot_longer(
    cols = c(mean_d_sub_cm, mean_d_pot_cm),
    names_to = "metric",
    values_to = "mean_change"
  ) %>%
  mutate(
    sd = dplyr::case_when(
      metric == "mean_d_sub_cm" ~ sd_d_sub_cm,
      metric == "mean_d_pot_cm" ~ sd_d_pot_cm
    ),
    metric = dplyr::recode(metric,
                    "mean_d_sub_cm" = "Above Substrate",
                    "mean_d_pot_cm" = "Above Pot"),
    interval = factor(time_point, 
                      levels = unique(height_steps$time_point)) # keeps order TP0→TP6
  )
```

Line plot: same axes per species, separate lines per treatment

```{r}
ggplot(plot_step,
       aes(x = time_point, y = mean_change,
           color = treatment_name, shape = treatment_name,
           group = treatment_name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_change - sd,
                    ymax = mean_change + sd),
                width = 0.15) +
    # geom_text(aes(label = n),
    #         position = position_dodge(width = 0.9),
    #         vjust = -0.5, size = 3) +
  facet_grid(rows = vars(species), cols = vars(metric), scales = "free_y") +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  scale_x_continuous(breaks = 0:6, labels = paste0("TP", 0:6)) +
  labs(
    title = "Stepwise Height Change per Time Period",
    x = "Time Period",
    y = "Mean Height Change (cm)"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

✅ This will give you **lines across intervals (TP0→TP1, …, TP5→TP6)** for both **Above Substrate** and **Above Pot**, faceted by species × treatment.


Everything After this Point is questionable!!




---

### 3. Compute AGR & RGR (per plant)

```{r AGR-RGR}
by_prop <- surv %>%
  group_by(species, treatment_name, prop_id) %>%
  arrange(time_period, .by_group = TRUE) %>%
  mutate(
    dt = time_period - lag(time_period),
    h_mean = total_height_mean_cm,
    h_mean_lag = lag(h_mean),
    h_mean_pos = ifelse(h_mean > 0, h_mean, NA_real_),
    h_mean_pos_lag = ifelse(h_mean_lag > 0, h_mean_lag, NA_real_),
    AGR = (h_mean - h_mean_lag) / dt,
    RGR = (log(h_mean_pos) - log(h_mean_pos_lag)) / dt
  ) %>%
  ungroup()
```

---

### 4. Summarize by Species × Substrate × Time\_Period

```{r}
growth_summary <- by_prop %>%
  group_by(species, treatment_name, time_period) %>%
  summarise(
    n_records = n(),
    mean_total_height_cm = mean(total_height_mean_cm, na.rm = TRUE),
    sd_total_height_cm   = sd(total_height_mean_cm, na.rm = TRUE),
    mean_branches        = mean(number_branches, na.rm = TRUE),
    sd_branches          = sd(number_branches, na.rm = TRUE),
    mean_AGR_cm_per_TP   = mean(AGR, na.rm = TRUE),
    sd_AGR_cm_per_TP     = sd(AGR, na.rm = TRUE),
    mean_RGR_per_TP      = mean(RGR, na.rm = TRUE),
    sd_RGR_per_TP        = sd(RGR, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(species, treatment_name, time_period)

print(growth_summary, n = 30)
```

---

### 5. Export (optional)

```{r}
# Save to CSV if you want a table
readr::write_csv(growth_summary,
  "C:/Users/sarai/OneDrive/Email attachments/Documents/UVI/Thesis.Work/SargMangs/OutputData/growth_summary_by_species_substrate_TP.csv")
```


### 1) Mean Total Height (cm) — line + ribbon (± SD), faceted by species

```{r}
ggplot(growth_summary,
       aes(x = time_period, y = mean_total_height_cm,
           color = treatment_name, group = treatment_name)) +
  geom_line() +
  geom_point() +
  geom_ribbon(aes(ymin = mean_total_height_cm - sd_total_height_cm,
                  ymax = mean_total_height_cm + sd_total_height_cm,
                  fill = treatment_name),
              alpha = 0.18, color = NA) +
  facet_wrap(~ species, scales = "free_y") +
  labs(x = "Month", y = "Mean Total Height (cm)",
       title = "Total Height (Mean ± SD) by Species & Substrate") +
    scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  scale_x_continuous(breaks = sort(unique(growth_summary$time_period))) +
  theme_minimal()
```

---

### 2) Mean AGR (cm per TP) — line + ribbon (± SD), faceted by species

```{r}
ggplot(growth_summary,
       aes(x = time_period, y = mean_AGR_cm_per_TP,
           color = treatment_name, group = treatment_name)) +
  geom_line() +
  geom_point() +
  geom_ribbon(aes(ymin = mean_AGR_cm_per_TP - sd_AGR_cm_per_TP,
                  ymax = mean_AGR_cm_per_TP + sd_AGR_cm_per_TP,
                  fill = treatment_name),
              alpha = 0.18, color = NA) +
  facet_wrap(~ species, scales = "free_y") +
  labs(x = "Month", y = "Mean AGR (cm per TP)",
       title = "Absolute Growth Rate (Mean ± SD) by Species & Substrate") +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  scale_x_continuous(breaks = sort(unique(growth_summary$time_period))) +
  theme_minimal()
```

---

### 3) Mean RGR (1 per TP) — line + ribbon (± SD), faceted by species

```{r}
ggplot(growth_summary,
       aes(x = time_period, y = mean_RGR_per_TP,
           color = treatment_name, group = treatment_name)) +
  geom_line() +
  geom_point() +
  geom_ribbon(aes(ymin = mean_RGR_per_TP - sd_RGR_per_TP,
                  ymax = mean_RGR_per_TP + sd_RGR_per_TP,
                  fill = treatment_name),
              alpha = 0.18, color = NA) +
  facet_wrap(~ species, scales = "free_y") +
  labs(x = "Time Period", y = "Mean RGR (1 per TP)",
       title = "Relative Growth Rate (Mean ± SD) by Species & Substrate") +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  scale_x_continuous(breaks = sort(unique(growth_summary$time_period))) +
  theme_minimal()
```


See where RGR is negative and how many plants contribute
```{r}
neg_rgr <- growth_summary %>%
  filter(mean_RGR_per_TP < 0) %>%
  arrange(species, treatment_name, time_period) %>%
  select(species, treatment_name, time_period,
         n_records, mean_RGR_per_TP, sd_RGR_per_TP)
neg_rgr

```

If you didn’t save contributor counts for RGR, add them:
```{r}
# Rebuild contributor counts for RGR if missing
by_prop_counts <- by_prop %>%
  group_by(species, treatment_name, time_period) %>%
  summarise(n_RGR = sum(!is.na(RGR)), .groups = "drop")

growth_summary <- growth_summary %>%
  left_join(by_prop_counts, by = c("species","treatment_name","time_period"))

```


---

### (Optional) switch ribbons to **SE** instead of SD

If you prefer **Mean ± SE**, create SE columns and swap them into the ribbons:

```r
growth_summary_se <- growth_summary %>%
  mutate(
    se_total = sd_total_height_cm / sqrt(pmax(1, n_records)),
    se_agr   = sd_AGR_cm_per_TP / sqrt(pmax(1, n_records)),
    se_rgr   = sd_RGR_per_TP / sqrt(pmax(1, n_records))
  )
```

Then replace `sd_*` with `se_*` in the three plotting chunks (e.g., `ymin = mean_total_height_cm - se_total`, etc.).


### Species contrasts within each substrate × time
```{r}
species_contrasts <- growth_summary %>%
  select(species, treatment_name, time_period,
         mean_total_height_cm, mean_AGR_cm_per_TP, mean_RGR_per_TP) %>%
  pivot_wider(names_from = species,
              values_from = c(mean_total_height_cm, mean_AGR_cm_per_TP, mean_RGR_per_TP)) %>%
  mutate(
    height_diff_LARA_minus_RHMA = mean_total_height_cm_LARA - mean_total_height_cm_RHMA,
    AGR_diff_LARA_minus_RHMA    = mean_AGR_cm_per_TP_LARA - mean_AGR_cm_per_TP_RHMA,
    RGR_diff_LARA_minus_RHMA    = mean_RGR_per_TP_LARA - mean_RGR_per_TP_RHMA
  ) %>%
  arrange(treatment_name, time_period)

print(species_contrasts, n = 100)

```

```{r}
ggplot(growth_summary,
       aes(x = time_period, y = mean_total_height_cm, color = treatment_name, group = treatment_name)) +
  geom_line() + geom_point() +
  geom_ribbon(aes(ymin = mean_total_height_cm - sd_total_height_cm,
                  ymax = mean_total_height_cm + sd_total_height_cm,
                  fill = treatment_name), alpha = 0.15, color = NA) +
  facet_wrap(~ species, scales = "free_y") +
  labs(x = "Month", y = "Mean Total Height (cm)", title = "Total Height (Mean \u00B1 SE) by Species and Substrate") +
  scale_color_manual(values = color_vals, name = "Treatment") +
  scale_fill_manual(values = color_vals, name = "Treatment") +
  scale_shape_manual(values = shape_vals, name = "Treatment") +
  theme_minimal()

```

```{r}
lmer(total_height_mean_cm ~ treatment_name * time_period + (1|prop_id), data=surv_use %>% filter(species=="RHMA"))
```
```{r}
library(lmerTest)
library(emmeans)

m_rhma <- lmer(total_height_mean_cm ~ treatment_name * time_period + (1 | prop_id),
               data = surv_use %>% dplyr::filter(species == "RHMA"))

## Predicted means at TP6 and pairwise contrasts (Tukey-adjusted)
emm_tp6 <- emmeans(m_rhma, ~ treatment_name | time_period,
                   at = list(time_period = 6))
emm_tp6
pairs(emm_tp6, adjust = "tukey")

## Compare growth slopes (cm per TP) across substrates
emtr <- emtrends(m_rhma, ~ treatment_name, var = "time_period")
emtr
pairs(emtr, adjust = "tukey")

## (Optional) Predicted means for TP0–TP6 to recreate the lines from the model
emm_grid <- emmeans(m_rhma, ~ treatment_name * time_period,
                    at = list(time_period = 0:6))
as.data.frame(emm_grid)
```
Fit the LARA model (same spec as RHMA)
```{r}
# If you don't already have m_rhma in memory, uncomment:
# m_rhma <- lmer(total_height_mean_cm ~ treatment_name * time_period + (1 | prop_id),
#                data = surv_use %>% filter(species == "RHMA"))

m_lara <- lmer(total_height_mean_cm ~ treatment_name * time_period + (1 | prop_id),
               data = surv_use %>% filter(species == "LARA"))

summary(m_lara)

```

TP6 estimated means and contrasts vs Soil (RHMA & LARA)
```{r}
# RHMA TP6 means and Soil-vs-others contrasts
emm_tp6_rhma <- emmeans(m_rhma, ~ treatment_name | time_period,
                        at = list(time_period = 6))
tp6_contrasts_rhma <- contrast(emm_tp6_rhma, method = "trt.vs.ctrl",
                               ref = "Soil", adjust = "dunnett") %>%
  as.data.frame() %>%
  mutate(Species = "RHMA")

# LARA TP6 means and Soil-vs-others contrasts
emm_tp6_lara <- emmeans(m_lara, ~ treatment_name | time_period,
                        at = list(time_period = 6))
tp6_contrasts_lara <- contrast(emm_tp6_lara, method = "trt.vs.ctrl",
                               ref = "Soil", adjust = "dunnett") %>%
  as.data.frame() %>%
  mutate(Species = "LARA")

# Combine for a side-by-side table
tp6_contrasts_both <- bind_rows(tp6_contrasts_rhma, tp6_contrasts_lara) %>%
  relocate(Species) %>%
  arrange(Species, contrast)

tp6_contrasts_both

```
(Interpretation: estimate is Treatment − Soil at TP6 in cm; negative = shorter than Soil. p.value is Dunnett-adjusted.)

Growth slopes (cm per TP) via emtrends and contrasts vs Soil
```{r}
# RHMA slopes and Soil-vs-others contrasts
emtr_rhma <- emtrends(m_rhma, ~ treatment_name, var = "time_period")
slope_contrasts_rhma <- contrast(emtr_rhma, method = "trt.vs.ctrl",
                                 ref = "Soil", adjust = "dunnett") %>%
  as.data.frame() %>%
  mutate(Species = "RHMA")

# LARA slopes and Soil-vs-others contrasts
emtr_lara <- emtrends(m_lara, ~ treatment_name, var = "time_period")
slope_contrasts_lara <- contrast(emtr_lara, method = "trt.vs.ctrl",
                                 ref = "Soil", adjust = "dunnett") %>%
  as.data.frame() %>%
  mutate(Species = "LARA")

# Combine for a side-by-side table
slope_contrasts_both <- bind_rows(slope_contrasts_rhma, slope_contrasts_lara) %>%
  relocate(Species) %>%
  arrange(Species, contrast)

slope_contrasts_both

```

```{r}
readr::write_csv(tp6_contrasts_both,
 "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs/OutputData/TP6_contrasts_vs_Soil_RHMA_LARA.csv")

readr::write_csv(slope_contrasts_both,
  "C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs/OutputData/Slope_contrasts_vs_Soil_RHMA_LARA.csv")

```


```{r}
# --- Rebuild contrasts WITH confidence intervals ---
library(lmerTest)
library(emmeans)
library(dplyr)
library(stringr)
library(glue)

# Ensure models exist
if (!exists("m_rhma")) m_rhma <- lmer(total_height_mean_cm ~ treatment_name * time_period + (1 | prop_id),
                                      data = surv_use %>% dplyr::filter(species == "RHMA"))
if (!exists("m_lara")) m_lara <- lmer(total_height_mean_cm ~ treatment_name * time_period + (1 | prop_id),
                                      data = surv_use %>% dplyr::filter(species == "LARA"))

# TP6 means
emm_tp6_rhma <- emmeans(m_rhma, ~ treatment_name | time_period, at = list(time_period = 6))
emm_tp6_lara <- emmeans(m_lara, ~ treatment_name | time_period, at = list(time_period = 6))

tp6_contrasts_rhma <- contrast(emm_tp6_rhma, "trt.vs.ctrl", ref = "Soil", adjust = "dunnett") |>
  summary(infer = c(TRUE, TRUE)) |>
  as.data.frame() |>
  mutate(Species = "RHMA")

tp6_contrasts_lara <- contrast(emm_tp6_lara, "trt.vs.ctrl", ref = "Soil", adjust = "dunnett") |>
  summary(infer = c(TRUE, TRUE)) |>
  as.data.frame() |>
  mutate(Species = "LARA")

tp6_contrasts_both <- bind_rows(tp6_contrasts_rhma, tp6_contrasts_lara)

# Slopes (cm/TP)
emtr_rhma <- emtrends(m_rhma, ~ treatment_name, var = "time_period")
emtr_lara <- emtrends(m_lara, ~ treatment_name, var = "time_period")

slope_contrasts_rhma <- contrast(emtr_rhma, "trt.vs.ctrl", ref = "Soil", adjust = "dunnett") |>
  summary(infer = c(TRUE, TRUE)) |>
  as.data.frame() |>
  mutate(Species = "RHMA")

slope_contrasts_lara <- contrast(emtr_lara, "trt.vs.ctrl", ref = "Soil", adjust = "dunnett") |>
  summary(infer = c(TRUE, TRUE)) |>
  as.data.frame() |>
  mutate(Species = "LARA")

slope_contrasts_both <- bind_rows(slope_contrasts_rhma, slope_contrasts_lara)

```


```{r}
# --- Helpers (robust CI extractor + formatting) ---
fmt_num <- function(x, d = 2) formatC(x, format = "f", digits = d)
fmt_p   <- function(p) ifelse(p < .001, "<0.001", sprintf("%.3f", p))

ci_cols <- function(df) {
  n <- nrow(df)
  lower <- if ("lower.CL" %in% names(df)) df$lower.CL else if ("asymp.LCL" %in% names(df)) df$asymp.LCL else rep(NA_real_, n)
  upper <- if ("upper.CL" %in% names(df)) df$upper.CL else if ("asymp.UCL" %in% names(df)) df$asymp.UCL else rep(NA_real_, n)
  tibble(lower = lower, upper = upper)
}

extract_treatment <- function(x) stringr::str_replace(x, " - Soil$", "")

```

```{r}
# --- Rebuild bullets (now with CIs present) ---
tp6_bullets <- tp6_contrasts_both %>%
  mutate(Treatment = extract_treatment(contrast),
         Direction = ifelse(estimate < 0, "lower", "higher"),
         Magnitude = abs(estimate),
         Species = factor(Species, levels = c("LARA","RHMA"))) %>%
  bind_cols(ci_cols(.)) %>%
  arrange(Species, Treatment) %>%
  mutate(
    bullet = glue("- {Species}: At TP6, **{Treatment}** is **{Direction}** than **Soil** by {fmt_num(Magnitude)} cm ",
                  "(95% CI {fmt_num(lower)}, {fmt_num(upper)}; p = {fmt_p(p.value)}).")
  )

slope_bullets <- slope_contrasts_both %>%
  mutate(Treatment = extract_treatment(contrast),
         Direction = ifelse(estimate < 0, "slower", "faster"),
         Magnitude = abs(estimate),
         Species = factor(Species, levels = c("LARA","RHMA"))) %>%
  bind_cols(ci_cols(.)) %>%
  arrange(Species, Treatment) %>%
  mutate(
    bullet = glue("- {Species}: Growth in **{Treatment}** is **{Direction}** than **Soil** by {fmt_num(Magnitude)} cm/TP ",
                  "(95% CI {fmt_num(lower)}, {fmt_num(upper)}; p = {fmt_p(p.value)}).")
  )

# Show only significant (alpha = 0.05); remove filters to show all
tp6_sig   <- tp6_bullets  %>% filter(p.value < 0.05)
slope_sig <- slope_bullets %>% filter(p.value < 0.05)

cat("\n### TP6 mean height vs Soil (significant only)\n")
if (nrow(tp6_sig) == 0) cat("- No significant differences at TP6.\n") else cat(paste0(tp6_sig$bullet, "\n"), sep = "")

cat("\n### Growth slopes vs Soil (cm per TP; significant only)\n")
if (nrow(slope_sig) == 0) cat("- No significant slope differences.\n") else cat(paste0(slope_sig$bullet, "\n"), sep = "")

```

```{r}
# Slope table (emtrends) with CIs and Dunnett vs Soil, both species
library(dplyr); library(emmeans); library(tidyr)

mk_slope_table <- function(mod, sp){
  emtr <- emtrends(mod, ~ treatment_name, var = "time_period")
  slopes <- summary(emtr, infer = c(TRUE, TRUE)) %>% as.data.frame()
  contr  <- contrast(emtr, "trt.vs.ctrl", ref = "Soil", adjust = "dunnett") %>%
    summary(infer = c(TRUE, TRUE)) %>% as.data.frame()
  left_join(
    slopes %>%
      transmute(Species = sp,
                treatment_name,
                slope_cm_per_TP = time_period.trend,
                slope_LCL = lower.CL, slope_UCL = upper.CL),
    contr %>%
      transmute(Species = sp,
                treatment_name = sub(" - Soil$", "", contrast),
                diff_vs_Soil = estimate,
                diff_LCL = lower.CL, diff_UCL = upper.CL, p_value = p.value),
    by = c("Species","treatment_name")
  )
}

slope_tbl <- bind_rows(
  mk_slope_table(m_lara, "LARA"),
  mk_slope_table(m_rhma, "RHMA")
) %>%
  arrange(Species, treatment_name)

slope_tbl
# readr::write_csv(slope_tbl, "SargMangs/OutputData/slopes_and_diffs_vs_Soil.csv")

```

```{r}
# Simple slope plot with 95% CIs (one panel per species)
library(ggplot2)

ggplot(slope_tbl,
       aes(x = treatment_name, y = slope_cm_per_TP)) +
  geom_point(position = position_dodge(width = 0.6)) +
  geom_errorbar(aes(ymin = slope_LCL, ymax = slope_UCL),
                width = 0.15, position = position_dodge(width = 0.6)) +
  facet_wrap(~ Species, scales = "free_y") +
  labs(x = "Substrate", y = "Growth slope (cm per TP)",
       title = "Estimated growth slopes by substrate (±95% CI)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))

```


