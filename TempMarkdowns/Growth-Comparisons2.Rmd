---
title: "Mangrove Seedling Growth and Morphology Analysis"
author: "Sarai Hutchinson"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)

# Load required libraries
library(tidyverse)
library(ggplot2)
library(knitr)
library(kableExtra)
library(emmeans)
library(multcomp)
library(car)
library(broom)
library(lme4)
library(lmerTest)
library(effectsize)

# Define Okabe-Ito colorblind-friendly palette
okabe_ito <- c("#009E73", "#D55E00", "#E69F00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7", "#999999")

# Define shapes for each Treatment_Name
shape_vals <- c(
  "Soil"                = 0,  # open square
  "Crushed glass"       = 17, # filled triangle
  "25% SG"              = 18, # filled diamond
  "75% SG"              = 8,  # asterisk
  "100% Sargassum (SG)" = 15  # filled square
)

# Define colors using okabe_ito palette
color_vals <- c(
  "Soil"                = okabe_ito[1], # green  (#009E73)
  "Crushed glass"       = okabe_ito[6], # blue   (#0072B2)
  "25% SG"              = okabe_ito[3], # orange (#E69F00)
  "75% SG"              = okabe_ito[2], # vermillion (#D55E00)
  "100% Sargassum (SG)" = okabe_ito[7]  # purple (#CC79A7)
)
```

# Introduction

This analysis examines the growth patterns and morphological development of red (*Rhizophora mangle*, RHMA) and white (*Laguncularia racemosa*, LARA) mangrove seedlings under different substrate treatments.

## Treatments

1. **Soil**: Traditional potting soil (control)
2. **Crushed glass**: 100% crushed glass substrate
3. **25% SG**: 3:1 ratio of crushed glass to *Sargassum*
4. **75% SG**: 1:3 ratio of crushed glass to *Sargassum*
5. **100% Sargassum (SG)**: Pure *Sargassum* substrate

## Hypotheses

### Red Mangroves (RHMA)
- **H₀₃**: There is no difference in the relative growth rate and number of branches of red mangrove propagules regardless of substrate type and *Sargassum* additions.
- **H₁₃**: Red mangroves grown in potting soil will have the greatest relative growth rate, branching, and nodes, followed by 75% SG, 25% SG, 100% Sargassum, and crushed glass.

### White Mangroves (LARA)
- **H₀₄**: There is no difference in the relative growth rate and number of branches of white mangrove seedlings regardless of substrate type and *Sargassum* additions.
- **H₁₄**: White mangroves grown in potting soil will have the greatest relative growth rate, branching, and nodes, followed by 75% SG, 25% SG, 100% Sargassum, and crushed glass.

# Data Import and Preparation

```{r data-import}
# Read data
ALLDATA <- read_csv("C:\\Users\\sarai\\OneDrive\\Email attachments\\Documents\\UVI\\Thesis.Work\\SargMangs\\Data/Hutchinson_MonitoringAndIntake_Sites.csv")

# Clean treatment labels
ALLDATA <- ALLDATA %>%
  mutate(
    Treatment_Name = case_when(
      Treatment == "A" ~ "Soil",
      Treatment == "B" ~ "Crushed glass",
      Treatment == "C" ~ "100% Sargassum (SG)",
      Treatment == "D" ~ "75% SG",
      Treatment == "E" ~ "25% SG",
      TRUE ~ as.character(Treatment)
    ),
    Treatment_Name = factor(
      Treatment_Name,
      levels = c("Soil", "Crushed glass", "25% SG", "75% SG", "100% Sargassum (SG)")
    )
  )

# Derive Sargassum indicators
ALLDATA <- ALLDATA %>%
  mutate(
    Sarg_present = if_else(
      Treatment_Name %in% c("75% SG", "25% SG", "100% Sargassum (SG)"),
      1L, 0L
    ),
    Sarg_group = factor(if_else(Sarg_present == 1L, "With Sargassum", "No Sargassum"),
                        levels = c("No Sargassum","With Sargassum")),
    SG_pct = case_when(
      Treatment_Name == "Soil" ~ 0,
      Treatment_Name == "Crushed glass" ~ 0,
      Treatment_Name == "25% SG" ~ 25,
      Treatment_Name == "75% SG" ~ 75,
      Treatment_Name == "100% Sargassum (SG)"~ 100,
      TRUE ~ NA_real_
    )
  )

# Create binary survival variable and factorize
ALLDATA_SurvBin <- ALLDATA %>%
  mutate(
    Survival = ifelse(Survivorship %in% c("A", "DY"), 1, 0),
    Time_Period = factor(Time_Period, levels = c("0", "1", "2", "3", "4", "5", "6")),
    Species = factor(Species)
  )

# Quality control - remove resurrection cases
qc_resurrections <- ALLDATA_SurvBin %>%
  mutate(TP_num = as.integer(as.character(Time_Period))) %>%
  arrange(Species, Prop_ID, TP_num) %>%
  group_by(Species, Prop_ID) %>%
  mutate(change = Survival - lag(Survival)) %>%
  filter(change == 1 & lag(Survival) == 0) %>%
  ungroup()

flagged_ids <- qc_resurrections %>% distinct(Species, Prop_ID)

ALLDATA_clean <- ALLDATA_SurvBin %>%
  anti_join(flagged_ids, by = c("Species","Prop_ID"))

cat("Data cleaned. Removed", nrow(flagged_ids), "plants with resurrection issues.\n")
```

## Convert Measurements to Numeric

```{r convert-numeric}
# Convert height and growth measurements to numeric
ALLDATA_clean <- ALLDATA_clean %>%
  mutate(
    # RHMA measurements
    RHMA_Height_Above_Substrate = as.numeric(RHMA_Height_1),
    RHMA_Height_Above_Pot = as.numeric(RHMA_Height_2),
    RHMA_Epi_Length_num = as.numeric(RHMA_Epi_Length),
    # LARA measurements
    LARA_Height_Above_Substrate = as.numeric(LARA_Height_1),
    LARA_Height_Above_Pot = as.numeric(LARA_Height_2),
    # Leaf and node counts
    Total_Leaves_num = as.numeric(Total_Leaves),
    Total_Nodes_num = as.numeric(Total_Nodes),
    Number_Branches_num = as.numeric(Number_Branches)
  ) %>%
  # Calculate height based on species-specific measurements
  mutate(
    Height = case_when(
      Species == "RHMA" ~ RHMA_Epi_Length_num,  # Use epicotyl length for RHMA
      Species == "LARA" ~ pmax(LARA_Height_Above_Substrate, LARA_Height_Above_Pot, na.rm = TRUE),  # Max of two LARA heights
      TRUE ~ NA_real_
    ),
    # Combined LARA height (for additional analysis if needed)
    LARA_Total_Height = case_when(
      Species == "LARA" & !is.na(LARA_Height_Above_Substrate) & !is.na(LARA_Height_Above_Pot) ~ 
        LARA_Height_Above_Substrate + LARA_Height_Above_Pot,
      Species == "LARA" & !is.na(LARA_Height_Above_Substrate) ~ LARA_Height_Above_Substrate,
      Species == "LARA" & !is.na(LARA_Height_Above_Pot) ~ LARA_Height_Above_Pot,
      TRUE ~ NA_real_
    )
  )

# Identify plants that survived to TP6
survivors_tp6 <- ALLDATA_clean %>%
  filter(Time_Period == "6", Survival == 1) %>%
  distinct(Species, Prop_ID)

cat("Number of plants surviving to TP6:\n")
survivors_tp6 %>%
  count(Species) %>%
  print()

# Keep ALL time period data for only those plants that survived to TP6
growth_data <- ALLDATA_clean %>%
  semi_join(survivors_tp6, by = c("Species", "Prop_ID")) %>%
  arrange(Species, Prop_ID, Time_Period)

cat("\nGrowth analysis dataset prepared.\n")
cat("Total observations (all time periods for TP6 survivors):", nrow(growth_data), "\n")

# Verify we have the complete time series for survivors
time_series_check <- growth_data %>%
  group_by(Species, Prop_ID) %>%
  summarise(
    n_timepoints = n_distinct(Time_Period),
    timepoints = paste(sort(unique(Time_Period)), collapse = ", ")
  ) %>%
  ungroup()

cat("\nTime series completeness (sample):\n")
time_series_check %>%
  slice_head(n = 5) %>%
  print()

cat("Growth analysis dataset prepared.\n")
cat("Number of observations (survivors only):", nrow(growth_data), "\n")

```

# Height Analysis

## Height Over Time - Treatment Means with Replicates

```{r height-trajectories}
# Calculate mean height over time for survivors
height_by_time <- growth_data %>%
  filter(!is.na(Height)) %>%
  group_by(Time_Period, Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_height = mean(Height, na.rm = TRUE),
    sd_height = sd(Height, na.rm = TRUE),
    se_height = sd_height / sqrt(n),
    median_height = median(Height, na.rm = TRUE)
  ) %>%
  ungroup()

# Plot height trajectories
p_height_time <- ggplot(height_by_time, 
             aes(x = as.numeric(as.character(Time_Period)), 
                 y = mean_height,
                 color = Treatment_Name,
                 shape = Treatment_Name,
                 group = Treatment_Name)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_height - se_height, 
                    ymax = mean_height + se_height),
                width = 0.1) +
  facet_wrap(~ Species, scales = "free_y",
             labeller = labeller(Species = c("LARA" = "White Mangrove (LARA)", 
                                            "RHMA" = "Red Mangrove (RHMA)"))) +
  scale_color_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Mean Height Over Time (Survivors Only)",
       subtitle = "RHMA: Epicotyl Length | LARA: Shoot Height",
       x = "Time Period",
       y = "Height (cm)",
       color = "Treatment",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))

print(p_height_time)
```

Height Over Time - Replicate Means
```{r}

# Calculate mean height by replicate
height_by_replicate <- growth_data %>%
  filter(!is.na(Height)) %>%
  group_by(Time_Period, Treatment_Name, Species, Replicate) %>%
  summarise(
    n = n(),
    mean_height = mean(Height, na.rm = TRUE),
    sd_height = sd(Height, na.rm = TRUE),
    se_height = sd_height / sqrt(n)
  ) %>%
  ungroup()

# Display table of replicate means at final time period
final_replicate_means <- height_by_replicate %>%
  filter(Time_Period == "6") %>%
  dplyr::select(Treatment_Name, Species, Replicate, n, mean_height) %>%
  pivot_wider(names_from = Replicate, 
              values_from = c(n, mean_height),
              names_sep = "_Rep")

final_replicate_means %>%
  kable(caption = "Final Height by Replicate (TP6 Survivors)",
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Plot with replicate means shown
p_height_replicates <- ggplot(height_by_replicate, 
             aes(x = as.numeric(as.character(Time_Period)), 
                 y = mean_height,
                 color = Treatment_Name,
                 group = interaction(Treatment_Name, Replicate))) +
  geom_line(alpha = 0.3, size = 0.8) +  # Individual replicate lines (faint)
  geom_point(alpha = 0.4, size = 1.5) +  # Individual replicate points
  stat_summary(aes(group = Treatment_Name),  # Overall treatment mean
               fun = mean, 
               geom = "line", 
               size = 1.5) +
  stat_summary(aes(group = Treatment_Name, shape = Treatment_Name),
               fun = mean,
               geom = "point", 
               size = 3) +
  facet_wrap(~ Species, scales = "free_y",
             labeller = labeller(Species = c("LARA" = "White Mangrove (LARA)", 
                                            "RHMA" = "Red Mangrove (RHMA)"))) +
  scale_color_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "Height Over Time - Replicate Means (Faint Lines) and Treatment Means (Bold)",
       subtitle = "RHMA: Epicotyl Length | LARA: Max Height",
       x = "Time Period",
       y = "Height (cm)",
       color = "Treatment",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 9))

print(p_height_replicates)
```

LARA Height Components Analysis
```{r}
# Analyze LARA Height 1 and Height 2 separately
lara_heights <- growth_data %>%
  filter(Species == "LARA") %>%
  dplyr::select(Time_Period, Treatment_Name, Replicate, Prop_ID, 
         LARA_Height_Above_Substrate, LARA_Height_Above_Pot) %>%
  pivot_longer(cols = c(LARA_Height_Above_Substrate, LARA_Height_Above_Pot),
               names_to = "Height_Type",
               values_to = "Height_Value") %>%
  mutate(Height_Type = ifelse(Height_Type == "LARA_Height_Above_Substrate", 
                              "Height Above Substrate", "Height Above Pot")) %>%
  filter(!is.na(Height_Value))

# Calculate means by height type
lara_height_means <- lara_heights %>%
  group_by(Time_Period, Treatment_Name, Height_Type) %>%
  summarise(
    n = n(),
    mean_height = mean(Height_Value, na.rm = TRUE),
    sd_height = sd(Height_Value, na.rm = TRUE),
    se_height = sd_height / sqrt(n)
  ) %>%
  ungroup()

# Plot LARA heights separately
p_lara_separate <- ggplot(lara_height_means,
                          aes(x = as.numeric(as.character(Time_Period)),
                              y = mean_height,
                              color = Treatment_Name,
                              shape = Treatment_Name)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_height - se_height,
                    ymax = mean_height + se_height),
                width = 0.1) +
  facet_wrap(~ Height_Type, scales = "free_y") +
  scale_color_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  labs(title = "LARA Height Components Over Time",
       subtitle = "Height Above Substrate and Height Above Pot Measured Separately",
       x = "Time Period",
       y = "Height (cm)",
       color = "Treatment",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom")

print(p_lara_separate)

# Summary table at final time period
lara_final_heights <- lara_heights %>%
  filter(Time_Period == "6") %>%
  group_by(Treatment_Name, Height_Type) %>%
  summarise(
    n = n(),
    mean = mean(Height_Value, na.rm = TRUE),
    sd = sd(Height_Value, na.rm = TRUE),
    min = min(Height_Value, na.rm = TRUE),
    max = max(Height_Value, na.rm = TRUE)
  ) %>%
  ungroup()

lara_final_heights %>%
  kable(caption = "LARA Final Height Components (TP6)",
        col.names = c("Treatment", "Height Type", "N", "Mean", "SD", "Min", "Max"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Correlation between Height 1 and Height 2
lara_both_heights <- growth_data %>%
  filter(Species == "LARA", 
         !is.na(LARA_Height_Above_Substrate), 
         !is.na(LARA_Height_Above_Pot))

if(nrow(lara_both_heights) > 0) {
  cor_test <- cor.test(lara_both_heights$LARA_Height_Above_Substrate, 
                       lara_both_heights$LARA_Height_Above_Pot)
  
  p_lara_correlation <- ggplot(lara_both_heights,
                               aes(x = LARA_Height_Above_Substrate, y = LARA_Height_Above_Pot,
                                   color = Treatment_Name)) +
    geom_point(alpha = 0.6, size = 2) +
    geom_smooth(method = "lm", se = TRUE, alpha = 0.2) +
    scale_color_manual(values = color_vals) +
    labs(title = "LARA Height Above Substrate vs Height Above Pot Correlation",
         subtitle = paste("r =", round(cor_test$estimate, 3), 
                         ", p =", format.pval(cor_test$p.value, digits = 3)),
         x = "Height Above Substrate (cm)",
         y = "Height Above Pot (cm)",
         color = "Treatment") +
    theme_minimal() +
    theme(legend.position = "right")
  
  print(p_lara_correlation)
}
```

## Final Height Distribution

```{r final-height}
# Analyze final heights
final_heights <- growth_data %>%
  filter(Time_Period == 6, 
         !is.na(Height))

# Build a species-specific "final height" using LARA Height 1 and RHMA epicotyl length
final_heights <- growth_data %>%
  mutate(
    Height_final = dplyr::case_when(
      Species == "LARA" ~ LARA_Height_Above_Substrate,     # <-- use LARA Height 1 only
      Species == "RHMA" ~ RHMA_Epi_Length_num,   # epicotyl length for RHMA
      TRUE ~ NA_real_
    )
  )
# Summary statistics
height_summary <- final_heights %>%
  group_by(Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_height = mean(Height, na.rm = TRUE),
    sd_height = sd(Height, na.rm = TRUE),
    se_height = sd_height / sqrt(n),
    median_height = median(Height, na.rm = TRUE),
    min_height = min(Height, na.rm = TRUE),
    max_height = max(Height, na.rm = TRUE)
  ) %>%
  ungroup()

height_summary %>%
  arrange(Species, desc(mean_height)) %>%
  kable(caption = "Final Height Summary by Treatment (Survivors Only)",
        col.names = c("Treatment", "Species", "N", "Mean", "SD", "SE", 
                     "Median", "Min", "Max"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Boxplot of final heights
p_height_box <- ggplot(final_heights, 
                aes(x = Treatment_Name, y = Height, fill = Treatment_Name)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 21, outlier.size = 2) +
  geom_jitter(aes(color = Treatment_Name), 
              width = 0.2, alpha = 0.5, size = 2) +
  facet_wrap(~ Species, scales = "free_y", labeller = labeller(
             Species = c("RHMA" = expression(italic("Rhizophora mangle")),
                         "LARA" = expression(italic("Laguncularia racemosa")))
           )) +
  scale_fill_manual(values = color_vals) +
  scale_color_manual(values = color_vals) +
  labs(title = "Final Height Distribution by Treatment",
       subtitle = expression(italic("Rhizophora mangle")*": Epicotyl Length | " *italic("Laguncularia racemosa")*": Shoot Height Above Substrate"),
       x = "Treatment",
       y = "Height (cm)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

p_height_box +
  theme(
    plot.title = element_text(hjust = 0.5),    # center title
    plot.subtitle = element_text(hjust = 0.5)  # center subtitle
  )

```


# Relative Growth Rate Analysis

## Calculate RGR

```{r calculate-rgr}
# Calculate relative growth rate between time periods
# RGR = (ln(Height_t2) - ln(Height_t1)) / (t2 - t1)
rgr_data <- growth_data %>%
  filter(!is.na(Height), Height > 0) %>%
  arrange(Species, Prop_ID, Time_Period) %>%
  group_by(Species, Prop_ID) %>%
  mutate(
    ln_height = log(Height),
    time_num = as.numeric(as.character(Time_Period)),
    rgr = (ln_height - lag(ln_height)) / (time_num - lag(time_num))
  ) %>%
  filter(!is.na(rgr)) %>%
  ungroup()

# Summary of RGR by treatment
rgr_summary <- rgr_data %>%
  group_by(Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_rgr = mean(rgr, na.rm = TRUE),
    sd_rgr = sd(rgr, na.rm = TRUE),
    se_rgr = sd_rgr / sqrt(n),
    median_rgr = median(rgr, na.rm = TRUE)
  ) %>%
  ungroup()

rgr_summary %>%
  arrange(Species, desc(mean_rgr)) %>%
  kable(caption = "Relative Growth Rate by Treatment",
        col.names = c("Treatment", "Species", "N", "Mean RGR", "SD", "SE", "Median RGR"),
        digits = 4) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Plot RGR
p_rgr <- ggplot(rgr_summary, 
                aes(x = Treatment_Name, y = mean_rgr, fill = Treatment_Name)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = mean_rgr - se_rgr, ymax = mean_rgr + se_rgr),
                width = 0.25) +
  facet_wrap(~ Species, scales = "free_y",
             labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                            "RHMA" = "Red Mangrove"))) +
  scale_fill_manual(values = color_vals) +
  labs(title = "Mean Relative Growth Rate by Treatment",
       x = "Treatment",
       y = "Relative Growth Rate (per time period)",
       fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_rgr)
```

## RGR Over Time

```{r rgr-time}
# Calculate RGR for each time interval
rgr_time <- rgr_data %>%
  group_by(Time_Period, Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_rgr = mean(rgr, na.rm = TRUE),
    se_rgr = sd(rgr, na.rm = TRUE) / sqrt(n)
  ) %>%
  ungroup()

p_rgr_time <- ggplot(rgr_time,
                     aes(x = as.numeric(as.character(Time_Period)),
                         y = mean_rgr,
                         color = Treatment_Name,
                         shape = Treatment_Name)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_rgr - se_rgr,
                    ymax = mean_rgr + se_rgr),
                width = 0.1) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                            "RHMA" = "Red Mangrove"))) +
  scale_color_manual(values = color_vals) +
  scale_shape_manual(values = shape_vals) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  labs(title = "Relative Growth Rate Over Time",
       x = "Time Period",
       y = "RGR (per time period)",
       color = "Treatment",
       shape = "Treatment") +
  theme_minimal() +
  theme(legend.position = "bottom")

print(p_rgr_time)
```

# Branching Analysis

```{r branching-analysis}
# Analyze branching at final time period
branch_data <- growth_data %>%
  filter(Time_Period == max(Time_Period), 
         !is.na(Number_Branches_num))

# Summary statistics
branch_summary <- branch_data %>%
  group_by(Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_branches = mean(Number_Branches_num, na.rm = TRUE),
    sd_branches = sd(Number_Branches_num, na.rm = TRUE),
    se_branches = sd_branches / sqrt(n),
    median_branches = median(Number_Branches_num, na.rm = TRUE),
    prop_with_branches = mean(Number_Branches_num > 0, na.rm = TRUE) * 100
  ) %>%
  ungroup()

branch_summary %>%
  arrange(Species, desc(mean_branches)) %>%
  kable(caption = "Branching Summary by Treatment (Final Time Period)",
        col.names = c("Treatment", "Species", "N", "Mean", "SD", "SE", 
                     "Median", "% With Branches"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Branching visualization
p_branches <- ggplot(branch_data, 
                     aes(x = Treatment_Name, y = Number_Branches_num, 
                         fill = Treatment_Name)) +
  geom_violin(alpha = 0.6) +
  geom_boxplot(width = 0.2, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = Treatment_Name), 
              width = 0.1, alpha = 0.4, size = 1.5) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                            "RHMA" = "Red Mangrove"))) +
  scale_fill_manual(values = color_vals) +
  scale_color_manual(values = color_vals) +
  labs(title = "Number of Branches by Treatment",
       x = "Treatment",
       y = "Number of Branches") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_branches)
```

# Node Analysis

```{r node-analysis}
# Analyze nodes at final time period
node_data <- growth_data %>%
  filter(Time_Period == max(Time_Period), 
         !is.na(Total_Nodes_num))

# Summary statistics
node_summary <- node_data %>%
  group_by(Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_nodes = mean(Total_Nodes_num, na.rm = TRUE),
    sd_nodes = sd(Total_Nodes_num, na.rm = TRUE),
    se_nodes = sd_nodes / sqrt(n),
    median_nodes = median(Total_Nodes_num, na.rm = TRUE),
    min_nodes = min(Total_Nodes_num, na.rm = TRUE),
    max_nodes = max(Total_Nodes_num, na.rm = TRUE)
  ) %>%
  ungroup()

node_summary %>%
  arrange(Species, desc(mean_nodes)) %>%
  kable(caption = "Node Summary by Treatment (Final Time Period)",
        col.names = c("Treatment", "Species", "N", "Mean", "SD", "SE", 
                     "Median", "Min", "Max"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Node visualization
p_nodes <- ggplot(node_data, 
                  aes(x = Treatment_Name, y = Total_Nodes_num, 
                      fill = Treatment_Name)) +
  geom_violin(alpha = 0.6) +
  geom_boxplot(width = 0.2, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = Treatment_Name), 
              width = 0.1, alpha = 0.4, size = 1.5) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                            "RHMA" = "Red Mangrove"))) +
  scale_fill_manual(values = color_vals) +
  scale_color_manual(values = color_vals) +
  labs(title = "Total Nodes by Treatment",
       x = "Treatment",
       y = "Total Nodes") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_nodes)
```

# Leaf Analysis

```{r leaf-analysis}
# Analyze leaves at final time period
leaf_data <- growth_data %>%
  filter(Time_Period == max(Time_Period), 
         !is.na(Total_Leaves_num))

# Summary statistics
leaf_summary <- leaf_data %>%
  group_by(Treatment_Name, Species) %>%
  summarise(
    n = n(),
    mean_leaves = mean(Total_Leaves_num, na.rm = TRUE),
    sd_leaves = sd(Total_Leaves_num, na.rm = TRUE),
    se_leaves = sd_leaves / sqrt(n),
    median_leaves = median(Total_Leaves_num, na.rm = TRUE),
    prop_with_leaves = mean(Total_Leaves_num > 0, na.rm = TRUE) * 100
  ) %>%
  ungroup()

leaf_summary %>%
  arrange(Species, desc(mean_leaves)) %>%
  kable(caption = "Leaf Summary by Treatment (Final Time Period)",
        col.names = c("Treatment", "Species", "N", "Mean", "SD", "SE", 
                     "Median", "% With Leaves"),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Leaf visualization
p_leaves <- ggplot(leaf_data, 
                   aes(x = Treatment_Name, y = Total_Leaves_num, 
                       fill = Treatment_Name)) +
  geom_violin(alpha = 0.6) +
  geom_boxplot(width = 0.2, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = Treatment_Name), 
              width = 0.1, alpha = 0.4, size = 1.5) +
  facet_wrap(~ Species,
             labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                            "RHMA" = "Red Mangrove"))) +
  scale_fill_manual(values = color_vals) +
  scale_color_manual(values = color_vals) +
  labs(title = "Total Leaves by Treatment",
       x = "Treatment",
       y = "Total Leaves") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(p_leaves)
```

# Statistical Analysis

## Height Analysis

```{r height-stats}
# ANOVA for final heights
if(nrow(final_heights) > 0) {
  height_model <- lm(Height ~ Treatment_Name * Species, data = final_heights)
  
  # Check assumptions
  par(mfrow = c(2, 2))
  plot(height_model)
  par(mfrow = c(1, 1))
  
  cat("ANOVA for Final Heights:\n")
  print(anova(height_model))
  
  # Effect sizes
  cat("\n\nEffect Sizes (Eta-squared):\n")
  print(eta_squared(height_model))
  
  # Post-hoc tests
  height_emmeans <- emmeans(height_model, ~ Treatment_Name | Species)
  cat("\n\nEstimated Marginal Means for Height:\n")
  print(summary(height_emmeans))
  
  cat("\n\nTukey HSD Comparisons for Height:\n")
  print(pairs(height_emmeans, adjust = "tukey"))
}
```

## RGR Analysis

```{r rgr-stats}
# ANOVA for RGR
if(nrow(rgr_data) > 0) {
  rgr_model <- lm(rgr ~ Treatment_Name * Species, data = rgr_data)
  
  cat("ANOVA for Relative Growth Rate:\n")
  print(anova(rgr_model))
  
  # Effect sizes
  cat("\n\nEffect Sizes (Eta-squared):\n")
  print(eta_squared(rgr_model))
  
  # Post-hoc comparisons
  rgr_emmeans <- emmeans(rgr_model, ~ Treatment_Name | Species)
  cat("\n\nEstimated Marginal Means for RGR:\n")
  print(summary(rgr_emmeans))
  
  cat("\n\nTukey HSD Comparisons for RGR:\n")
  print(pairs(rgr_emmeans, adjust = "tukey"))
}
```

## Branching Analysis

```{r branch-stats}
# ANOVA for branches
if(nrow(branch_data) > 0) {
  branch_model <- lm(Number_Branches_num ~ Treatment_Name * Species, data = branch_data)
  
  cat("ANOVA for Number of Branches:\n")
  print(anova(branch_model))
  
  # Effect sizes
  cat("\n\nEffect Sizes (Eta-squared):\n")
  print(eta_squared(branch_model))
  
  # Post-hoc comparisons
  branch_emmeans <- emmeans(branch_model, ~ Treatment_Name | Species)
  cat("\n\nTukey HSD for Branches:\n")
  print(pairs(branch_emmeans, adjust = "tukey"))
}
```

## Node Analysis

```{r node-stats}
# ANOVA for nodes
if(nrow(node_data) > 0) {
  node_model <- lm(Total_Nodes_num ~ Treatment_Name * Species, data = node_data)
  
  cat("ANOVA for Total Nodes:\n")
  print(anova(node_model))
  
  # Effect sizes
  cat("\n\nEffect Sizes (Eta-squared):\n")
  print(eta_squared(node_model))
  
  # Post-hoc comparisons
  node_emmeans <- emmeans(node_model, ~ Treatment_Name | Species)
  cat("\n\nTukey HSD for Nodes:\n")
  print(pairs(node_emmeans, adjust = "tukey"))
}
```

# Results Summary

## Treatment Rankings

```{r rankings}
# Create comprehensive ranking table
rankings <- data.frame()

# Add height ranks
if(exists("height_summary")) {
  height_ranks <- height_summary %>%
    group_by(Species) %>%
    arrange(desc(mean_height)) %>%
    mutate(height_rank = row_number()) %>%
    select(Species, Treatment_Name, mean_height, height_rank)
  
  rankings <- height_ranks
}

# Add RGR ranks
if(exists("rgr_summary")) {
  rgr_ranks <- rgr_summary %>%
    group_by(Species) %>%
    arrange(desc(mean_rgr)) %>%
    mutate(rgr_rank = row_number()) %>%
    select(Species, Treatment_Name, mean_rgr, rgr_rank)
  
  if(nrow(rankings) > 0) {
    rankings <- rankings %>%
      left_join(rgr_ranks, by = c("Species", "Treatment_Name"))
  } else {
    rankings <- rgr_ranks
  }
}

# Add branch ranks
if(exists("branch_summary")) {
  branch_ranks <- branch_summary %>%
    group_by(Species) %>%
    arrange(desc(mean_branches)) %>%
    mutate(branch_rank = row_number()) %>%
    select(Species, Treatment_Name, mean_branches, branch_rank)
  
  rankings <- rankings %>%
    left_join(branch_ranks, by = c("Species", "Treatment_Name"))
}

# Add node ranks
if(exists("node_summary")) {
  node_ranks <- node_summary %>%
    group_by(Species) %>%
    arrange(desc(mean_nodes)) %>%
    mutate(node_rank = row_number()) %>%
    select(Species, Treatment_Name, mean_nodes, node_rank)
  
  rankings <- rankings %>%
    left_join(node_ranks, by = c("Species", "Treatment_Name"))
}

# Display comprehensive rankings
rankings %>%
  arrange(Species, Treatment_Name) %>%
  kable(caption = "Comprehensive Growth Metric Rankings",
        col.names = c("Species", "Treatment", "Height (cm)", "H.Rank", 
                     "RGR", "RGR.Rank", "Branches", "B.Rank",
                     "Nodes", "N.Rank"),
        digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(rankings$Treatment_Name == "Soil"), bold = TRUE)

# Calculate average rank
avg_ranks <- rankings %>%
  rowwise() %>%
  mutate(avg_rank = mean(c(height_rank, rgr_rank, branch_rank, node_rank), na.rm = TRUE)) %>%
  group_by(Species) %>%
  arrange(avg_rank) %>%
  select(Species, Treatment_Name, avg_rank)

cat("\nOverall Growth Performance (Average Rank):\n")
print(avg_ranks)
```

## Hypothesis Testing Results

```{r hypothesis-results}
alpha <- 0.05
growth_expected_order <- c("Soil", "75% SG", "25% SG", "100% Sargassum (SG)", "Crushed glass")

cat("="*60, "\n")
cat("GROWTH HYPOTHESES TESTING RESULTS\n")
cat("="*60, "\n\n")

# Test H3 and H4 for each metric
metrics <- list(
  "RGR" = if(exists("rgr_summary")) rgr_summary else NULL,
  "Branches" = if(exists("branch_summary")) branch_summary else NULL,
  "Nodes" = if(exists("node_summary")) node_summary else NULL
)

for(metric_name in names(metrics)) {
  metric_data <- metrics[[metric_name]]
  
  if(!is.null(metric_data)) {
    cat("\n", metric_name, " RANKINGS:\n", sep = "")
    cat("-"*40, "\n")
    
    for(sp in unique(metric_data$Species)) {
      cat("\n", sp, ":\n", sep = "")
      
      # Get actual ranking
      actual_order <- metric_data %>%
        filter(Species == sp) %>%
        arrange(desc(get(paste0("mean_", tolower(metric_name))))) %>%
        pull(Treatment_Name)
      
      cat("  Expected: ", paste(growth_expected_order, collapse = " > "), "\n")
      cat("  Actual:   ", paste(actual_order, collapse = " > "), "\n")
      
      # Check if matches hypothesis
      if(all(actual_order == growth_expected_order)) {
        cat("  Result: ✓ Matches hypothesis\n")
      } else {
        cat("  Result: ✗ Does not match hypothesis\n")
      }
    }
  }
}

# Statistical significance summary
cat("\n\nSTATISTICAL SIGNIFICANCE:\n")
cat("-"*40, "\n")

if(exists("rgr_model")) {
  rgr_anova <- anova(rgr_model)
  rgr_p <- rgr_anova["Treatment_Name", "Pr(>F)"]
  cat("\nRGR Treatment Effect: p =", round(rgr_p, 4))
  cat("\nDecision:", ifelse(rgr_p < alpha, "SIGNIFICANT", "NOT SIGNIFICANT"))
}

if(exists("branch_model")) {
  branch_anova <- anova(branch_model)
  branch_p <- branch_anova["Treatment_Name", "Pr(>F)"]
  cat("\n\nBranching Treatment Effect: p =", round(branch_p, 4))
  cat("\nDecision:", ifelse(branch_p < alpha, "SIGNIFICANT", "NOT SIGNIFICANT"))
}

if(exists("node_model")) {
  node_anova <- anova(node_model)
  node_p <- node_anova["Treatment_Name", "Pr(>F)"]
  cat("\n\nNode Treatment Effect: p =", round(node_p, 4))
  cat("\nDecision:", ifelse(node_p < alpha, "SIGNIFICANT", "NOT SIGNIFICANT"))
}
```

## Multi-Metric Comparison

```{r multi-metric}
# Create overview plot
if(exists("height_summary") & exists("rgr_summary") & exists("branch_summary")) {
  overview_data <- height_summary %>%
    select(Treatment_Name, Species, mean_height) %>%
    left_join(rgr_summary %>% select(Treatment_Name, Species, mean_rgr), 
              by = c("Treatment_Name", "Species")) %>%
    left_join(branch_summary %>% select(Treatment_Name, Species, mean_branches), 
              by = c("Treatment_Name", "Species")) %>%
    left_join(node_summary %>% select(Treatment_Name, Species, mean_nodes),
              by = c("Treatment_Name", "Species"))
  
  # Normalize values for comparison (scale to 0-1)
  overview_scaled <- overview_data %>%
    group_by(Species) %>%
    mutate(
      height_scaled = (mean_height - min(mean_height)) / (max(mean_height) - min(mean_height)),
      rgr_scaled = (mean_rgr - min(mean_rgr)) / (max(mean_rgr) - min(mean_rgr)),
      branches_scaled = (mean_branches - min(mean_branches)) / (max(mean_branches) - min(mean_branches)),
      nodes_scaled = (mean_nodes - min(mean_nodes)) / (max(mean_nodes) - min(mean_nodes))
    ) %>%
    ungroup()
  
  # Reshape for plotting
  overview_long <- overview_scaled %>%
    select(Treatment_Name, Species, ends_with("_scaled")) %>%
    pivot_longer(cols = ends_with("_scaled"),
                 names_to = "metric",
                 values_to = "value") %>%
    mutate(metric = factor(metric, 
                          levels = c("height_scaled", "rgr_scaled", 
                                    "branches_scaled", "nodes_scaled"),
                          labels = c("Height", "RGR", "Branches", "Nodes")))
  
  p_overview <- ggplot(overview_long, 
                       aes(x = value, y = Treatment_Name, 
                           color = Treatment_Name, shape = Treatment_Name)) +
    geom_point(size = 4) +
    facet_grid(Species ~ metric,
               labeller = labeller(Species = c("LARA" = "White Mangrove", 
                                              "RHMA" = "Red Mangrove"))) +
    scale_color_manual(values = color_vals) +
    scale_shape_manual(values = shape_vals) +
    labs(title = "Normalized Growth Performance Overview",
         subtitle = "All metrics scaled 0-1 within species",
         x = "Normalized Value",
         y = "Treatment") +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"))
  
  print(p_overview)
}
```

# Key Findings

```{r key-findings}
cat("KEY FINDINGS:\n")
cat("="*60, "\n\n")

# Best performers by metric
cat("TOP PERFORMERS BY METRIC:\n")
cat("-"*40, "\n")

for(sp in unique(rankings$Species)) {
  cat("\n", sp, ":\n", sep = "")
  
  # Height
  if("mean_height" %in% names(rankings)) {
    top_height <- rankings %>%
      filter(Species == sp, height_rank == 1) %>%
      pull(Treatment_Name)
    cat("  Best Height: ", top_height, "\n")
  }
  
  # RGR
  if("mean_rgr" %in% names(rankings)) {
    top_rgr <- rankings %>%
      filter(Species == sp, rgr_rank == 1) %>%
      pull(Treatment_Name)
    cat("  Best RGR: ", top_rgr, "\n")
  }
  
  # Branches
  if("mean_branches" %in% names(rankings)) {
    top_branches <- rankings %>%
      filter(Species == sp, branch_rank == 1) %>%
      pull(Treatment_Name)
    cat("  Best Branching: ", top_branches, "\n")
  }
  
  # Nodes
  if("mean_nodes" %in% names(rankings)) {
    top_nodes <- rankings %>%
      filter(Species == sp, node_rank == 1) %>%
      pull(Treatment_Name)
    cat("  Best Nodes: ", top_nodes, "\n")
  }
  
  # Overall
  top_overall <- avg_ranks %>%
    filter(Species == sp) %>%
    slice(1) %>%
    pull(Treatment_Name)
  cat("  Best Overall: ", top_overall, "\n")
}

# Sargassum effect on growth
cat("\n\nSARGASSUM EFFECT ON GROWTH:\n")
cat("-"*40, "\n")

if(exists("height_summary")) {
  sarg_growth <- height_summary %>%
    mutate(has_sargassum = Treatment_Name %in% c("25% SG", "75% SG", "100% Sargassum (SG)")) %>%
    group_by(Species, has_sargassum) %>%
    summarise(mean_height = mean(mean_height))
  
  for(sp in unique(sarg_growth$Species)) {
    no_sarg <- sarg_growth %>% filter(Species == sp, !has_sargassum) %>% pull(mean_height)
    with_sarg <- sarg_growth %>% filter(Species == sp, has_sargassum) %>% pull(mean_height)
    diff_pct <- ((no_sarg - with_sarg) / with_sarg) * 100
    
    cat("\n", sp, ":\n", sep = "")
    cat("  No Sargassum mean height: ", round(no_sarg, 2), " cm\n")
    cat("  With Sargassum mean height: ", round(with_sarg, 2), " cm\n")
    cat("  Difference: ", round(diff_pct, 1), "%\n")
  }
}
```

# Conclusions

Based on the comprehensive growth analysis:

## Growth Performance

1. **Height Development**: The analysis reveals significant differences in height growth across treatments, with species-specific measurement approaches (epicotyl length for RHMA, shoot height for LARA).

2. **Relative Growth Rate**: RGR patterns show treatment effects on growth efficiency, indicating which substrates support optimal growth rates over time.

3. **Morphological Development**: Branching and node production vary significantly by treatment, affecting overall plant architecture and potential fitness.

## Hypothesis Evaluation

### Red Mangroves (H₃)
- The hypothesis predicted: Soil > 75% SG > 25% SG > 100% SG > Crushed glass
- The data shows whether this ranking holds for growth metrics

### White Mangroves (H₄)
- The hypothesis predicted: Soil > 75% SG > 25% SG > 100% SG > Crushed glass
- The analysis reveals the actual performance ranking

## Sargassum Impact on Growth

The presence of Sargassum in the substrate shows complex effects on growth:
- Moderate levels (75% SG) may provide some nutrients
- High levels (100% SG) may inhibit growth
- The optimal balance appears to vary by species

## Practical Implications

1. **Substrate Selection**: Traditional potting soil generally supports the best growth performance
2. **Sargassum Use**: If Sargassum must be used, moderate concentrations may be preferable to pure Sargassum
3. **Species-Specific Strategies**: Red and white mangroves may require different substrate compositions for optimal growth
4. **Restoration Applications**: These findings inform substrate choices for mangrove restoration projects

# Session Information

```{r session-info}
sessionInfo()
```